<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Apparel Style Solution - Stock & Sales Management</title>
    
    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6; /* Lighter background */
            color: #333;
        }
        
        /* Header Logo Styling (This is for the main application header, already okay) */
        .main-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            background-color: #fff;
            border-bottom: 2px solid #ddd;
        }

        .header-logo {
            max-width: 80px;
            height: auto;
            margin-right: 15px;
        }

        .header-text {
            text-align: left;
        }

        .header-text h3 {
            margin: 0;
            color: ##004d40;
            font-size: 20px;
        }

        .header-text h4 {
            margin: 0;
            color: #555;
            font-size: 14px;
        }
        
        /* Navigation Styling (from user provided code) */
        nav {
            width: 99%;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
            display: flex;
        }
        nav button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
            font-size: 8px;
            white-space: nowrap;
            transition: background-color 0.3s;
        }
        nav button:hover {
            background-color: #4cae4c;
        }
        
        /* Main Content Styling (from user provided code) */
        main {
            position: relative;
            width: 100%;
            height: auto;
            border-radius: 20px;
            padding: 1px;
            margin-top: 40px;
            box-sizing: border-box;
            background: #ecf0f3;
            box-shadow: 14px 14px 20px #cbced1, -14px -14px 20px white;
        }
        
        /* Section Header */
        h2 {
            color: #004d40;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            background-color: #fff;
        }
        table th, table td {
            width: auto;
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            font-size: 12px;
        }
        table th {
            background-color: #e9e9e9;
        }
        
        /* Form Styling (simplified) */
        form {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        /* Utility */
        .hidden {
            display: none;
        }
        .due-amount-highlight {
            color: red;
            font-weight: bold;
        }

        /* INVOICE SPECIFIC STYLES - FROM ORIGINAL REQUEST WITH WATERMARK */
        #downloadableInvoice {
            /* **‡¶ì‡ßü‡¶æ‡¶ü‡¶æ‡¶∞‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤** */
            position: relative; 
            overflow: hidden; 
            padding: 30px;
            margin: 20px auto;
            border: 1px solid #ccc;
            background-color: #fff;
            max-width: 800px; /* Increased size for better PDF rendering */
            box-sizing: border-box;
            font-size: 15px;
        }

        /* Watermark Logo Styling */
        .invoice-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            width: 80%; /* ‡¶™‡ßç‡¶∞‡¶∂‡¶∏‡ßç‡¶§‡¶§‡¶æ‡¶∞ 80% */
            height: auto;
            opacity: 0.1; /* 10% ‡¶Ö‡¶™‡¶æ‡¶∏‡¶ø‡¶ü‡¶ø */
            z-index: 0; /* ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá */
            pointer-events: none;
        }

        /* üëá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡ßß ‡¶®‡¶Ç ‡¶∏‡ßç‡¶•‡¶æ‡¶®: ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶ü‡¶™ ‡¶≤‡ßã‡¶ó‡ßã ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        /* ‡¶è‡¶á ‡¶≤‡ßã‡¶ó‡ßã‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® download-invoice-header ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ü‡¶õ‡ßá */
        #downloadableInvoice .invoice-logo {
            /* ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
            display: none; /* ‡¶Ø‡¶æ‡¶§‡ßá ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶≤‡ßã‡¶ó‡ßã ‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡ßü */
        }

        /* üëá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡ß® ‡¶®‡¶Ç ‡¶∏‡ßç‡¶•‡¶æ‡¶®: ‡¶®‡¶§‡ßÅ‡¶® Flex Header ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (‡¶™‡¶æ‡¶∂‡¶æ‡¶™‡¶æ‡¶∂‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) */
        .download-invoice-header {
            display: flex;
            align-items: center; /* ‡¶≤‡ßã‡¶ó‡ßã ‡¶è‡¶¨‡¶Ç ‡¶π‡ßá‡¶°‡¶ø‡¶Ç-‡¶è‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá */
            justify-content: center; /* ‡¶™‡ßÅ‡¶∞‡ßã ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡¶ü‡¶ø‡¶ï‡ßá ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá */
            margin-bottom: 20px;
            position: relative; 
            z-index: 1;
        }

        .download-invoice-header .invoice-logo {
            max-width: 80px; /* ‡¶≤‡ßã‡¶ó‡ßã‡¶∞ ‡¶Ü‡¶ï‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
            height: auto;
            margin: 0 15px 0 0; /* ‡¶π‡ßá‡¶°‡¶ø‡¶Ç ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨ */
            display: block !important; /* ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ø‡ßá ‡¶≤‡ßã‡¶ó‡ßã‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá */
        }

        .download-invoice-header h1 {
            text-align: center; /* ‡¶¨‡¶æ‡¶Æ‡¶¶‡¶ø‡¶ï‡ßá ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá */
            color: ##004d40;
            margin: 0; /* ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶® ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã */
            font-size: 20px; /* ‡¶´‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶Ü‡¶ï‡¶æ‡¶∞ ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
            line-height: 1.2;
        }
        /* üëÜ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑ */
        
        /* ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶π‡ßá‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        #downloadableInvoice h1 {
            font-size: 24px;
        }

        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .invoice-details strong {
            display: inline-block;
            width: 120px;
        }
        .invoice-total-summary {
            text-align: right;
            margin-top: 20px;
            position: relative;
            z-index: 1;
            font-size: 16px;
        }
        .invoice-total-summary div {
            padding: 5px 0;
            font-weight: bold;
        }
        .invoice-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            text-align: center;
            font-size: 12px;
            color: #666;
            position: relative;
            z-index: 1;
        }
        /* End of Invoice Specific Styles */

        /* Existing Styles from user provided code (truncated for brevity but included in the final code block) */
        #currentStockTable tr:nth-child(even) { background-color: #f2f2f2; }
        form label { display: inline-block; margin-bottom: 8px; font-weight: bold; width: 120px; }
        form input[type="text"], form input[type="number"] { width: calc(100% - 130px); padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        form button[type="submit"] { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 8px; margin-top: 10px; }
        .item-name-link, .customer-name-link { color: #007bff; text-decoration: underline; cursor: pointer; }
        #jsonEditorSection textarea { width: 100%; height: 250px; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        #invoiceContainer { border: 1px solid #ccc; padding: 20px; margin-top: 20px; background-color: #fefefe; border-radius: 8px; }
        #invoiceTable th, #invoiceTable td { border: 1px solid #eee; padding: 10px; text-align: left; }
        #invoiceTable tfoot td { font-weight: bold; font-size: 13px; background-color: #f2f2f2; }
        #invoiceActions { text-align: right; margin-top: 15px; }
        #finalizeSaleBtn { background-color: #007bff; color: white; }
        #clearInvoiceBtn { background-color: #dc3545; color: white; }
        .add-to-cart-form { display: flex; align-items: center; gap: 5px; margin-top: 1px; }
        .add-to-cart-form input[type="number"] { width: 30px; height: 10px; margin-bottom: 0; padding: 5px; box-sizing: border-box; }
        .add-to-cart-form button { background-color: #17a2b8; color: white; padding: 3px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin-top: 0; }
        .cart-checkout-buttons { text-align: right; margin-top: 20px; }
        #goToInvoiceBtn { background-color: #28a745; color: white; }
        .pay-due-btn, .download-customer-invoice-btn { background-color: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin-top: 5px; margin-right: 5px; }
        .download-customer-invoice-btn { background-color: #ffc107; color: #333; }
        #monthlyReportControls { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #e6f7ff; display: flex; gap: 15px; align-items: center; }
        #monthlyReportControls select, #monthlyReportControls button { padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; }
        
        }
    </style>
</head>
<body>
    
    <header>
        <div class="main-header">
            <img src="img.png" alt="Modern Apparel Style Solutian Logo" class="header-logo">
            <div class="header-text">
                <h2>Modern Apparel Style Solution (MASS)</h2>
                <h4>Stock Management System</h4>
            </div>
        </div>
        <nav>
            <button id="btnStockView">Current Stock</button>
            <button id="btnStockEntry">Stock Entry</button>
            <button id="btnStockOut">Stock Out (Direct)</button>
            <button id="btnOverallReport">Overall Report</button>
            <button id="btnMonthlyReport" style="background-color: #ffc107; color: #333;">Monthly Sales Report</button>
            <button id="btnShowAllData">Show All Data</button>
            <button id="btnSellInvoice" style="background-color: #20c997;">Generate Invoice</button>
            <button id="btnCustomers" style="background-color: #6f42c1; color: white;">Customers</button>
            <button id="btnJsonEdit" style="background-color: #17a2b8;">JSON Edit</button>
        </nav>
    </header>

    <main id="content">
        <section id="stockViewSection">
            <h2 id="h2">Current Stock Data</h2>
            <p id="hint">Select items below and add them to your cart before generating an invoice.</p>
            <table id="currentStockTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Available Quantity</th>
                        <th>Price (per unit) (TK)</th>
                        <th>Add to Cart</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </section>

        <section id="stockEntrySection" class="hidden">
            <h2>Stock Entry</h2>
            <form id="stockEntryForm">
                <label for="entryItemName">Item Name:</label>
                <input type="text" id="entryItemName" required><br><br>

                <label for="entryItemSize">Size:</label>
                <input type="text" id="entryItemSize" required><br><br>

                <label for="entryQuantity">Quantity:</label>
                <input type="number" id="entryQuantity" min="1" required><br><br>

                <label for="entryPrice">Price (per unit) (TK):</label>
                <input type="number" id="entryPrice" min="0" step="0.01" required><br><br>

                <button type="submit">Add Stock</button>
            </form>
        </section>

        <section id="stockOutSection" class="hidden">
            <h2>Stock Out (Direct Removal)</h2>
            <p>Use this for direct removal of stock not related to an invoice/sale.</p>
            <form id="stockOutForm">
                <label for="outItemName">Item Name:</label>
                <input type="text" id="outItemName" required><br><br>

                <label for="outItemSize">Size:</label>
                <input type="text" id="outItemSize" required><br><br>

                <label for="outQuantity">Quantity to Remove:</label>
                <input type="number" id="outQuantity" min="1" required><br><br>

                <button type="submit">Remove Stock Directly</button>
            </form>
        </section>

        <section id="overallReportSection" class="hidden">
            <h2>Overall Stock & Due Report</h2>
            <p><strong>Total Stock Quantity:</strong> <span id="totalStockQuantityReport">0</span></p>
            <p id="tsv"><strong>Total Stock Value:</strong> <span id="totalStockValueReport">0.00 TK</span></p>
            <p><strong>Total Customer Due:</strong> <span id="totalCustomerDueReport" class="due-amount-highlight">0.00 TK</span></p>
        </section>

        <section id="reportByMonthSection" class="hidden">
            <h2>Monthly Sales Report (Invoice Summary)</h2>
            <div id="monthlyReportControls">
                <label for="reportMonth">Select Month:</label>
                <select id="reportMonth">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>

                <label for="reportYear">Select Year:</label>
                <select id="reportYear"></select>

                <button id="generateMonthlyReportBtn">Generate Report</button>
            </div>
            
            <h3>Summary for Selected Month:</h3>
            <table id="monthlyReportTable">
                <thead>
                    <tr>
                        <th>Total Invoices</th>
                        <th>Total Gross Sales (Subtotal)</th>
                        <th>Total Discount Given</th>
                        <th>Total Net Sales (Grand Total)</th>
                        <th>Total Paid Amount</th>
                        <th>Total New Due Generated</th>
                    </tr>
                </thead>
                <tbody id="monthlyReportSummaryBody">
                </tbody>
            </table>

            <h3>Detailed Invoice List:</h3>
            <table id="monthlyReportDetailTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Invoice No</th>
                        <th>Customer Name</th>
                        <th>Net Sale (TK)</th>
                        <th>Discount (TK)</th>
                        <th>Due (TK)</th>
                    </tr>
                </thead>
                <tbody id="monthlyReportDetailBody">
                </tbody>
            </table>
        </section>
        <section id="showAllDataSection" class="hidden">
            <h2>All Stock Data</h2>
            <h3>Current Aggregated Stock:</h3>
            <table id="allCurrentStockTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                        <th>Total Value (TK)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h3>Stock In Log:</h3>
            <table id="allStockInLogTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h3>Stock Out Log:</h3>
            <table id="allStockOutLogTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Invoice No</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </section>

        <section id="itemReportSection" class="hidden">
            <h2>Item Specific Report: <span id="itemReportName"></span></h2>
            <button id="backToAllData">Back to All Data</button>
            <h3>Stock In for <span id="itemReportInName"></span>:</h3>
            <table id="itemInReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h3>Stock Out for <span id="itemReportOutName"></span>:</h3>
            <table id="itemOutReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Invoice No</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h3>Current Stock for <span id="itemReportCurrentName"></span>:</h3>
            <table id="itemCurrentReportTable">
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="jsonEditorSection" class="hidden">
            <h2>Edit Raw Data (JSON)</h2>
            <p><strong>Warning:</strong> Editing this data directly can cause issues if the JSON is malformed. Use with caution.</p>

            <h3>Current Stock Data (`massStockData`)</h3>
            <textarea id="jsonStockData" rows="10"></textarea>
            <button id="saveStockDataJson" class="save">Save Stock Data</button>

            <h3>Stock In Log (`massStockInLog`)</h3>
            <textarea id="jsonStockInLog" rows="10"></textarea>
            <button id="saveStockInLogJson" class="save">Save Stock In Log</button>

            <h3>Stock Out Log (`massStockOutLog`)</h3>
            <textarea id="jsonStockOutLog" rows="10"></textarea>
            <button id="saveStockOutLogJson" class="save">Save Stock Out Log</button>

            <h3>Cart Data (`massCartItems`)</h3>
            <textarea id="jsonCartData" rows="5"></textarea>
            <button id="saveCartDataJson" class="save">Save Cart Data</button>

            <h3>Customer Data (`massCustomers`)</h3>
            <textarea id="jsonCustomerData" rows="10"></textarea>
            <button id="saveCustomerDataJson" class="save">Save Customer Data</button>

            <button id="cancelJson" class="cancel">Cancel</button>
        </section>
        
        <section id="cartViewSection" class="hidden">
            <h2>Your Cart</h2>
            <table id="cartTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Unit Price (TK)</th>
                        <th>Subtotal (TK)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                </tbody>
            </table>
            <div class="cart-checkout-buttons">
                <button id="goToInvoiceBtn">Go to Invoice</button>
                <button id="clearCartBtn">Clear Cart</button>
            </div>
        </section>

        <section id="sellInvoiceSection" class="hidden">
            <h2>Generate Invoice from Cart</h2>
            <p>Items in this invoice are pulled directly from your cart.</p>

            <div id="invoiceContainer">
                <img src="https://drive.google.com/uc?id=1ZQmt3yk0D-0ZCiNbnwIH1uDyWfS69Kvc" alt="MASS Company Logo" class="invoice-logo">
                <h3>Invoice</h3>
                <div id="customerDetailsForm">
                    <p>Enter Customer Details (Optional for direct sale):</p>
                    <label for="customerPhone">Phone Number:</label>
                    <input type="text" id="customerPhone" placeholder="e.g., 01XXXXXXXXX"><br>
                    <label for="customerName">Customer Name:</label>
                    <input type="text" id="customerName" placeholder="e.g., John Doe"><br>
                    <label for="customerAddress">Address:</label><br>
                    <input type="text" id="customerAddress" placeholder="e.g., 123 Main St"><br>
                </div>
                <div class="invoice-details">
                    <div>
                        <strong>Invoice Date:</strong> <span id="invoiceDateDisplay"></span><br>
                        <strong>Invoice No:</strong> <span id="invoiceNoDisplay"></span><br>
                        <strong>Customer:</strong> <span id="invoiceCustomerName">N/A</span> (<span id="invoiceCustomerPhone">N/A</span>)
                    </div>
                    <div style="text-align: right;">
                      
                        <strong>Customer Outstanding Due:</strong> <span id="customerOutstandingDueOnInvoice" class="due-amount-highlight">0.00 TK</span>
                    </div>
                </div>
                <table id="invoiceTable">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Size</th>
                            <th>Quantity</th>
                            <th>Unit Price (TK)</th>
                            <th>Subtotal (TK)</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Subtotal (Current Bill):</strong></td>
                            <td id="invoiceSubTotal">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Apply Discount?</strong></td>
                            <td colspan="2" style="text-align: left;">
                                <input type="checkbox" id="applyDiscountCheckbox" style="margin-right: 5px;"> **Discount**
                            </td>
                        </tr>
                        
                        <tr id="discountInputRow" class="hidden">
                            <td colspan="3" style="text-align: right;"><strong>Discount Amount (TK):</strong></td>
                            <td colspan="2">
                                <input type="number" id="discountAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 5px; box-sizing: border-box;">
                            </td>
                        </tr>
                        
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Grand Total (After Discount):</strong></td>
                            <td id="invoiceTotal">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Customer's Previous Due (TK):</strong></td>
                            <td id="previousDueDisplay" class="due-amount-highlight">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Total Payable (Current + Previous) (TK):</strong></td>
                            <td id="totalPayableDisplay" class="due-amount-highlight">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Paid Amount (TK):</strong></td>
                            <td colspan="2">
                                <input type="number" id="paidAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 5px; box-sizing: border-box;">
                            </td>
                        </tr>
                        
                        <tr id="dueAmountRow">
                            <td colspan="4" style="text-align: right;"><strong>Total Outstanding Due (TK):</strong></td>
                            <td id="dueAmountDisplay" class="due-amount-highlight">0.00 TK</td>
                        </tr>
                    </tfoot>
                    </table>
                <div id="invoiceActions">
                    <button id="finalizeSaleBtn">Finalize Sale & Record Stock Out</button>
                    <button id="downloadInvoicePdfBtn" style="background-color: #dc3545; color: white;">Download PDF</button>
                    <button id="backToCartBtn">Back to Cart</button>
                </div>
            </div>
        </section>

        <div id="downloadableInvoice" class="hidden">
            <img src="img.png" alt="MASS Company Logo Watermark" class="invoice-watermark">
            
            <div class="download-invoice-header"> 
                <img src="img.png" alt="MASS Company Logo" class="invoice-logo">
                <h1>Modern Apparel Style Solution (MASS) <br>Invoice</h1>
            </div>
            
            <div class="invoice-details">
                <div>
                    <strong>Invoice Date:</strong> <span id="downloadInvoiceDate"></span><br>
                    <strong>Invoice No:</strong> <span id="downloadInvoiceNo"></span>
                </div>
                <div>
                    <strong>Customer Name:</strong> <span id="downloadCustomerName">N/A</span><br>
                    <strong>Contact:</strong> <span id="downloadCustomerContact">N/A</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Unit Price (TK)</th>
                        <th>Subtotal (TK)</th>
                    </tr>
                </thead>
                <tbody id="downloadInvoiceTableBody">
                </tbody>
            </table>
            <div class="invoice-total-summary"> 
                <div>Subtotal: <span id="downloadInvoiceSubTotal">0.00 TK</span></div>
                <div>Discount: <span id="downloadInvoiceDiscount">0.00 TK</span></div>
                <div>Total (Net): <span id="downloadInvoiceTotal"></span></div>
                <div>Previous Due: <span id="downloadInvoicePreviousDue" class="due-amount-highlight">0.00 TK</span></div>
                <div>**Total Payable:** <span id="downloadInvoiceTotalPayable" class="due-amount-highlight">0.00 TK</span></div>
                <div>Paid: <span id="downloadInvoicePaid">0.00 TK</span></div>
                <div>Due: <span id="downloadInvoiceDue" class="due-amount-highlight">0.00 TK</span></div>
                </div>
            <div class="invoice-footer">
                Thank you for your business!<br>
                Modern Apparel Style Solution (MASS), Tongi, Dhaka Division, Bangladesh<br>
                Date Generated: <span id="generatedDateTime"></span>
            </div>
        </div>

        <section id="customersSection" class="hidden">
            <h2>Customer List</h2>
            <table id="customerListTable">
                <thead>
                    <tr>
                        <th>Phone Number</th>
                        <th>Customer Name</th>
                        <th>Total Purchases (TK)</th>
                        <th>Outstanding Due (TK)</th>
                        <th>Number of Orders</th>
                    </tr>
                </thead>
                <tbody id="customerListTableBody">
                </tbody>
            </table>
        </section>

        <section id="customerReportSection" class="hidden">
            <h2>Customer Purchase History: <span id="customerReportName"></span> (<span id="customerReportPhone"></span>)</h2>
            <button id="backToCustomersList">Back to Customer List</button>
            <h3>All Purchases</h3>
            <div id="customerPurchaseHistory">
            </div>
            <div class="purchase-summary">
                <strong>Sum Total of All Purchases:</strong> <span id="customerTotalSpent">0.00 TK</span><br>
                <strong>Total Outstanding Due:</strong> <span id="customerTotalDue" class="due-amount-highlight">0.00 TK</span>
            </div>
        </section>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCA-7y10NVwFG5hCNaafSw6_w1D0IsXo7s",
            authDomain: "mass-244c7.firebaseapp.com",
            databaseURL: "https://mass-244c7-default-rtdb.firebaseio.com",
            projectId: "mass-244c7",
            storageBucket: "mass-244c7.firebasestorage.app",
            messagingSenderId: "73049426644",
            appId: "1:73049426644:web:db8b7c598f6192f4700941",
            measurementId: "G-0DR3XNB5VQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // References to Firebase paths
        const stockDataRef = ref(database, 'stockData');
        const stockInLogRef = ref(database, 'stockInLog');
        const stockOutLogRef = ref(database, 'stockOutLog');
        const customersRef = ref(database, 'customers');

        // --- Data Storage (updated to prioritize Firebase) ---
        let stockData = [];
        let stockInLog = [];
        let stockOutLog = [];
        let cartItems = []; // Cart is now just a temporary in-memory variable
        let customers = [];
        let currentCustomerPreviousDue = 0; // NEW Global for previous due

        // --- Utility Functions for Data Handling ---

        // Function to save data to Firebase
        async function saveToFirebase(dataRef, data) {
            try {
                await set(dataRef, data);
                console.log(`Data saved to Firebase: ${dataRef.key}`);
            } catch (error) {
                console.error(`Error saving data to Firebase ${dataRef.key}:`, error);
                alert('Error saving data to cloud. Check your internet connection.');
            }
        }

        // --- Firebase Data Listener (Primary Data Source) ---
        onValue(stockDataRef, (snapshot) => {
            if (snapshot.exists()) {
                stockData = snapshot.val();
                console.log("StockData from Firebase:", stockData);
                renderStockView(); // Re-render UI after data update
            } else {
                stockData = []; // If data doesn't exist in Firebase, initialize as empty
                console.log("No stockData in Firebase.");
            }
        });

        onValue(stockInLogRef, (snapshot) => {
            if (snapshot.exists()) {
                stockInLog = snapshot.val();
                console.log("StockInLog from Firebase:", stockInLog);
            } else {
                stockInLog = [];
                console.log("No stockInLog in Firebase.");
            }
        });

        onValue(stockOutLogRef, (snapshot) => {
            if (snapshot.exists()) {
                stockOutLog = snapshot.val();
                console.log("StockOutLog from Firebase:", stockOutLog);
            } else {
                stockOutLog = [];
                console.log("No stockOutLog in Firebase.");
            }
        });

        onValue(customersRef, (snapshot) => {
            if (snapshot.exists()) {
                customers = snapshot.val();
                console.log("Customers from Firebase:", customers);
                // Also update customer-dependent reports if they are currently visible
                // For safety, only call if necessary or after initial load
                if (!document.getElementById('customersSection').classList.contains('hidden')) {
                    renderCustomersList();
                }
            } else {
                customers = [];
                console.log("No customers in Firebase.");
            }
        });

        // JavaScript Logic
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const contentDiv = document.getElementById('content');
            const stockViewSection = document.getElementById('stockViewSection');
            const stockEntrySection = document.getElementById('stockEntrySection');
            const stockOutSection = document.getElementById('stockOutSection');
            const showAllDataSection = document.getElementById('showAllDataSection');
            const itemReportSection = document.getElementById('itemReportSection');
            const jsonEditorSection = document.getElementById('jsonEditorSection');
            const cartViewSection = document.getElementById('cartViewSection');
            const sellInvoiceSection = document.getElementById('sellInvoiceSection');
            const customersSection = document.getElementById('customersSection');
            const customerReportSection = document.getElementById('customerReportSection');
            const overallReportSection = document.getElementById('overallReportSection');
            const reportByMonthSection = document.getElementById('reportByMonthSection'); // NEW

            // Buttons
            const btnStockView = document.getElementById('btnStockView');
            const btnStockEntry = document.getElementById('btnStockEntry');
            const btnStockOut = document.getElementById('btnStockOut');
            const btnShowAllData = document.getElementById('btnShowAllData');
            const btnJsonEdit = document.getElementById('btnJsonEdit');
            const btnSellInvoice = document.getElementById('btnSellInvoice');
            const btnCustomers = document.getElementById('btnCustomers');
            const btnOverallReport = document.getElementById('btnOverallReport');
            const btnMonthlyReport = document.getElementById('btnMonthlyReport'); // NEW
            const backToAllDataBtn = document.getElementById('backToAllData');
            const cancelJsonBtn = document.getElementById('cancelJson');
            const backToCustomersListBtn = document.getElementById('backToCustomersList');

            // Forms
            const stockEntryForm = document.getElementById('stockEntryForm');
            const stockOutForm = document.getElementById('stockOutForm');

            // Tables
            const currentStockTableBody = document.querySelector('#currentStockTable tbody');
            const allCurrentStockTableBody = document.querySelector('#allCurrentStockTable tbody');
            const allStockInLogTableBody = document.querySelector('#allStockInLogTable tbody');
            const allStockOutLogTableBody = document.querySelector('#allStockOutLogTable tbody');
            const itemInReportTableBody = document.querySelector('#itemInReportTable tbody');
            const itemOutReportTableBody = document.querySelector('#itemOutReportTable tbody');
            const itemCurrentReportTableBody = document.querySelector('#itemCurrentReportTable tbody');
            const customerListTableBody = document.getElementById('customerListTableBody');
            const cartTableBody = document.getElementById('cartTableBody');


            // Textareas for JSON editing
            const jsonStockDataTextarea = document.getElementById('jsonStockData');
            const jsonStockInLogTextarea = document.getElementById('jsonStockInLog');
            const jsonStockOutLogTextarea = document.getElementById('jsonStockOutLog');
            const jsonCartDataTextarea = document.getElementById('jsonCartData');
            const jsonCustomerDataTextarea = document.getElementById('jsonCustomerData');
            const saveStockDataJsonBtn = document.getElementById('saveStockDataJson');
            const saveStockInLogJsonBtn = document.getElementById('saveStockInLogJson');
            const saveStockOutLogJsonBtn = document.getElementById('saveStockOutLogJson');
            const saveCartDataJsonBtn = document.getElementById('saveCartDataJson');
            const saveCustomerDataJsonBtn = document.getElementById('saveCustomerDataJson');


            // Sell & Invoice Specific Elements
            const invoiceTableBody = document.getElementById('invoiceTableBody');
            const invoiceTotalDisplay = document.getElementById('invoiceTotal');
            const paidAmountInput = document.getElementById('paidAmount');
            const dueAmountDisplay = document.getElementById('dueAmountDisplay');
            const dueAmountRow = document.getElementById('dueAmountRow');
            const finalizeSaleBtn = document.getElementById('finalizeSaleBtn');
            const backToCartBtn = document.getElementById('backToCartBtn');
            const invoiceDateDisplay = document.getElementById('invoiceDateDisplay');
            const invoiceNoDisplay = document.getElementById('invoiceNoDisplay');
            const customerPhoneInput = document.getElementById('customerPhone');
            const customerNameInput = document.getElementById('customerName');
            const customerAddressInput = document.getElementById('customerAddress');
            const invoiceCustomerNameDisplay = document.getElementById('invoiceCustomerName');
            const invoiceCustomerPhoneDisplay = document.getElementById('invoiceCustomerPhone');
            const customerOutstandingDueOnInvoice = document.getElementById('customerOutstandingDueOnInvoice');
            const goToInvoiceBtn = document.getElementById('goToInvoiceBtn');
            const clearCartBtn = document.getElementById('clearCartBtn');
            const invoiceSubTotalDisplay = document.getElementById('invoiceSubTotal'); // NEW: For subtotal
            
            // NEW REFERENCES FOR INVOICE/DISCOUNT/DUE
            const discountAmountInput = document.getElementById('discountAmount');
            const applyDiscountCheckbox = document.getElementById('applyDiscountCheckbox');
            const discountInputRow = document.getElementById('discountInputRow');
            const previousDueDisplay = document.getElementById('previousDueDisplay'); // NEW
            const totalPayableDisplay = document.getElementById('totalPayableDisplay'); // NEW
            const downloadInvoicePdfBtn = document.getElementById('downloadInvoicePdfBtn'); // NEW


            // Elements for hidden downloadable invoice
            const downloadableInvoiceDiv = document.getElementById('downloadableInvoice');
            const downloadInvoiceDate = document.getElementById('downloadInvoiceDate');
            const downloadInvoiceNo = document.getElementById('downloadInvoiceNo');
            const downloadCustomerName = document.getElementById('downloadCustomerName');
            const downloadCustomerContact = document.getElementById('downloadCustomerContact');
            const downloadInvoiceTableBody = document.getElementById('downloadInvoiceTableBody');
            const downloadInvoiceTotal = document.getElementById('downloadInvoiceTotal');
            const downloadInvoicePaid = document.getElementById('downloadInvoicePaid');
            const downloadInvoiceDue = document.getElementById('downloadInvoiceDue');
            const generatedDateTime = document.getElementById('generatedDateTime');

            // NEW ELEMENTS FOR DOWNLOADABLE INVOICE TEMPLATE
            const downloadInvoiceSubTotal = document.getElementById('downloadInvoiceSubTotal');
            const downloadInvoiceDiscount = document.getElementById('downloadInvoiceDiscount');
            const downloadInvoicePreviousDue = document.getElementById('downloadInvoicePreviousDue');
            const downloadInvoiceTotalPayable = document.getElementById('downloadInvoiceTotalPayable');

            // Customer Report Elements
            const customerReportNameSpan = document.getElementById('customerReportName');
            const customerReportPhoneSpan = document.getElementById('customerReportPhone');
            const customerPurchaseHistoryDiv = document.getElementById('customerPurchaseHistory');
            const customerTotalSpentSpan = document.getElementById('customerTotalSpent');
            const customerTotalDueSpan = document.getElementById('customerTotalDue');

            // Overall Report Elements (New)
            const totalStockQuantityReport = document.getElementById('totalStockQuantityReport');
            const totalStockValueReport = document.getElementById('totalStockValueReport');
            const totalCustomerDueReport = document.getElementById('totalCustomerDueReport');

            // Monthly Report Elements (NEW)
            const reportMonthSelect = document.getElementById('reportMonth');
            const reportYearSelect = document.getElementById('reportYear');
            const generateMonthlyReportBtn = document.getElementById('generateMonthlyReportBtn');
            const monthlyReportSummaryBody = document.getElementById('monthlyReportSummaryBody');
            const monthlyReportDetailBody = document.getElementById('monthlyReportDetailBody');


            // Helper function to hide all sections
            function hideAllSections() {
                document.querySelectorAll('section').forEach(section => {
                    section.classList.add('hidden');
                });
            }

            // Function to generate a simple invoice number
            function generateInvoiceNumber() {
                const now = new Date();
                const year = now.getFullYear().toString().slice(-2);
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hour = now.getHours().toString().padStart(2, '0');
                const minute = now.getMinutes().toString().padStart(2, '0');
                const second = now.getSeconds().toString().padStart(2, '0');
                return `INV-${year}${month}${day}-${hour}${minute}${second}`;
            }

            // Helper function to format currency
            function formatCurrency(amount) {
                return `${parseFloat(amount).toFixed(2)} TK`;
            }

            // Function to render current stock view
            function renderStockView() {
                hideAllSections();
                stockViewSection.classList.remove('hidden');
                currentStockTableBody.innerHTML = '';

                // Aggregate stock data to display correctly (if there are multiple entries for same item+size)
                const aggregatedStock = {};
                stockData.forEach(item => {
                    const key = `${item.itemName}_${item.itemSize}`;
                    if (aggregatedStock[key]) {
                        aggregatedStock[key].quantity += item.quantity;
                    } else {
                        aggregatedStock[key] = { ...item, price: parseFloat(item.price) || 0 };
                    }
                });

                for (const key in aggregatedStock) {
                    const item = aggregatedStock[key];
                    const row = currentStockTableBody.insertRow();
                    row.insertCell(0).textContent = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = formatCurrency(item.price);

                    const addCell = row.insertCell(4);
                    const addForm = document.createElement('div');
                    addForm.classList.add('add-to-cart-form');
                    addForm.innerHTML = `
                        <input type="number" min="1" value="1" class="quantity-to-add-to-cart" data-item-name="${item.itemName}" data-item-size="${item.itemSize}">
                        <button class="add-to-cart-btn" data-item-name="${item.itemName}" data-item-size="${item.itemSize}">Add</button>
                    `;
                    addCell.appendChild(addForm);
                }
            }

            // --- Add to Cart Logic (from Stock View) ---
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const btn = e.target;
                    const itemName = btn.dataset.itemName;
                    const itemSize = btn.dataset.itemSize;
                    const quantityInput = btn.previousElementSibling;
                    const quantityToAdd = parseInt(quantityInput.value);

                    if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                        alert('Please enter a valid quantity to add to cart.');
                        return;
                    }

                    const availableItem = stockData.find(item =>
                        item.itemName.toLowerCase() === itemName.toLowerCase() &&
                        item.itemSize.toLowerCase() === itemSize.toLowerCase()
                    );

                    if (!availableItem) {
                        alert(`Item "${itemName}" with size "${itemSize}" not found in stock.`);
                        return;
                    }

                    // Check total available quantity in stock (aggregated)
                    let totalAvailableQuantity = 0;
                    stockData.filter(i =>
                        i.itemName.toLowerCase() === itemName.toLowerCase() &&
                        i.itemSize.toLowerCase() === itemSize.toLowerCase()
                    ).forEach(i => totalAvailableQuantity += i.quantity);


                    // Check quantity already in cart for this item
                    const currentCartQuantity = cartItems.find(item =>
                        item.itemName.toLowerCase() === itemName.toLowerCase() &&
                        item.itemSize.toLowerCase() === itemSize.toLowerCase()
                    )?.quantity || 0;

                    if ((currentCartQuantity + quantityToAdd) > totalAvailableQuantity) {
                         alert(`Not enough stock of "${itemName}" (${itemSize}). Available in stock: ${totalAvailableQuantity}. You already have ${currentCartQuantity} in cart.`);
                         return;
                    }

                    let itemInCart = cartItems.find(item =>
                        item.itemName.toLowerCase() === itemName.toLowerCase() &&
                        item.itemSize.toLowerCase() === itemSize.toLowerCase()
                    );

                    if (itemInCart) {
                        itemInCart.quantity += quantityToAdd;
                    } else {
                        cartItems.push({
                            itemName: availableItem.itemName,
                            itemSize: availableItem.itemSize,
                            quantity: quantityToAdd,
                            price: parseFloat(availableItem.price)
                        });
                    }

                    alert(`${quantityToAdd} x "${itemName}" (${itemSize}) added to cart!`);
                }
            });

            // Function to handle stock entry
            stockEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemName = document.getElementById('entryItemName').value.trim();
                const itemSize = document.getElementById('entryItemSize').value.trim();
                const quantity = parseInt(document.getElementById('entryQuantity').value);
                const price = parseFloat(document.getElementById('entryPrice').value);
                
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const date = `${day}/${month}/${year}`;

                if (itemName && itemSize && quantity > 0 && price >= 0) {
                    // Create copies to avoid race conditions with the onValue listener
                    const newStockData = [...stockData];
                    const newStockInLog = [...stockInLog];

                    const existingItemIndex = newStockData.findIndex(item =>
                        item.itemName.toLowerCase() === itemName.toLowerCase() &&
                        item.itemSize.toLowerCase() === itemSize.toLowerCase()
                    );

                    if (existingItemIndex !== -1) {
                        newStockData[existingItemIndex].quantity += quantity;
                        newStockData[existingItemIndex].price = price;
                    } else {
                        newStockData.push({ itemName, itemSize, quantity, price });
                    }

                    newStockInLog.push({ date, itemName, itemSize, quantity, price });

                    // Save both to Firebase. The onValue listeners will automatically update local variables and UI.
                    await saveToFirebase(stockDataRef, newStockData);
                    await saveToFirebase(stockInLogRef, newStockInLog);

                    alert('Stock added successfully!');
                    stockEntryForm.reset();
                } else {
                    alert('Please fill in all fields correctly.');
                }
            });

            // Function to handle stock out (direct removal - separate from invoice)
            stockOutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemName = document.getElementById('outItemName').value.trim();
                const itemSize = document.getElementById('outItemSize').value.trim();
                const quantityToRemove = parseInt(document.getElementById('outQuantity').value);
                
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const date = `${day}/${month}/${year}`;

                if (itemName && itemSize && quantityToRemove > 0) {
                    // Create copies to avoid race conditions with the onValue listener
                    const newStockData = [...stockData];
                    const newStockOutLog = [...stockOutLog];

                    let itemFoundAndRemoved = false;
                    const aggregatedItemIndex = newStockData.findIndex(item =>
                        item.itemName.toLowerCase() === itemName.toLowerCase() &&
                        item.itemSize.toLowerCase() === itemSize.toLowerCase()
                    );

                    if (aggregatedItemIndex !== -1) {
                        if (newStockData[aggregatedItemIndex].quantity >= quantityToRemove) {
                            newStockData[aggregatedItemIndex].quantity -= quantityToRemove;
                            newStockOutLog.push({ date, itemName, itemSize, quantity: quantityToRemove, invoiceNo: 'DIRECT_OUT' });
                            itemFoundAndRemoved = true;
                            if (newStockData[aggregatedItemIndex].quantity === 0) {
                                newStockData.splice(aggregatedItemIndex, 1);
                            }
                        } else {
                            alert(`Not enough stock. Available: ${newStockData[aggregatedItemIndex].quantity}`);
                            return;
                        }
                    }

                    if (itemFoundAndRemoved) {
                        await saveToFirebase(stockDataRef, newStockData);
                        await saveToFirebase(stockOutLogRef, newStockOutLog);

                        alert('Stock removed successfully!');
                        stockOutForm.reset();
                    } else {
                        alert('Item not found or incorrect details.');
                    }
                } else {
                    alert('Please fill in all fields correctly.');
                }
            });


            // New: Render Overall Report
            function renderOverallReport() {
                hideAllSections();
                overallReportSection.classList.remove('hidden');

                let totalQuantity = 0;
                let totalStockValue = 0;
                stockData.forEach(item => {
                    totalQuantity += item.quantity;
                    totalStockValue += item.quantity * (parseFloat(item.price) || 0);
                });

                let totalCustomerDue = 0;
                customers.forEach(customer => {
                    customer.purchases.forEach(purchase => {
                        totalCustomerDue += purchase.dueAmount || 0;
                    });
                });

                totalStockQuantityReport.textContent = totalQuantity;
                totalStockValueReport.textContent = formatCurrency(totalStockValue);
                totalCustomerDueReport.textContent = formatCurrency(totalCustomerDue);
            }

            // Function to initialize year dropdown for monthly report
            function initializeYearDropdown() {
                const currentYear = new Date().getFullYear();
                reportYearSelect.innerHTML = '';
                for (let i = currentYear; i >= currentYear - 5; i--) { // Show last 5 years
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === currentYear) {
                        option.selected = true;
                    }
                    reportYearSelect.appendChild(option);
                }
                // Set current month as default
                reportMonthSelect.value = new Date().getMonth() + 1;
            }

            // NEW: Render Monthly Report Section
            function renderMonthlyReportSection() {
                hideAllSections();
                reportByMonthSection.classList.remove('hidden');
                initializeYearDropdown();
                monthlyReportSummaryBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Select a month and year to generate the report.</td></tr>`;
                monthlyReportDetailBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No invoices found for this period.</td></tr>`;
            }

            // NEW: Function to Generate Monthly Report
            function generateMonthlyReport() {
                const selectedMonth = parseInt(reportMonthSelect.value);
                const selectedYear = parseInt(reportYearSelect.value);

                if (isNaN(selectedMonth) || isNaN(selectedYear)) {
                    alert("Please select a valid month and year.");
                    return;
                }

                let totalInvoices = 0;
                let totalGrossSales = 0;
                let totalDiscount = 0;
                let totalNetSales = 0;
                let totalPaidAmount = 0;
                let totalNewDueGenerated = 0;
                const monthlyInvoices = [];

                customers.forEach(customer => {
                    customer.purchases.forEach(purchase => {
                        // Date format is "DD/MM/YYYY"
                        const [day, month, year] = purchase.date.split('/').map(Number);
                        
                        if (month === selectedMonth && year === selectedYear) {
                            totalInvoices++;
                            
                            // Use the stored values in the purchase log (which already includes subtotal, discount, etc.)
                            const subTotal = purchase.subTotal || purchase.totalAmount || 0; // Fallback for older data
                            const discount = purchase.discount || 0;
                            const totalAmount = purchase.totalAmount || 0; // Net Sale after discount
                            const paidAmount = purchase.paidAmount || 0;
                            const dueAmount = purchase.dueAmount || 0;
                            
                            totalGrossSales += subTotal;
                            totalDiscount += discount;
                            totalNetSales += totalAmount;
                            totalPaidAmount += paidAmount;
                            
                            // Calculate new due generated in THIS invoice (excluding previous due)
                            // Due on Current Bill = (Total Amount - (Paid Amount - Previous Due, if Paid > Previous Due))
                            
                            let dueOnCurrentBill = totalAmount - Math.max(0, paidAmount - (purchase.previousDue || 0));
                            if (dueOnCurrentBill < 0) dueOnCurrentBill = 0;
                            
                            totalNewDueGenerated += dueOnCurrentBill;

                            monthlyInvoices.push({
                                date: purchase.date,
                                invoiceNo: purchase.invoiceNo,
                                customerName: customer.name || customer.phone || 'Guest',
                                netSale: totalAmount,
                                discount: discount,
                                due: dueAmount // This is the total outstanding due for that invoice
                            });
                        }
                    });
                });

                // Render Summary
                monthlyReportSummaryBody.innerHTML = '';
                const summaryRow = monthlyReportSummaryBody.insertRow();
                summaryRow.insertCell(0).textContent = totalInvoices;
                summaryRow.insertCell(1).textContent = formatCurrency(totalGrossSales);
                summaryRow.insertCell(2).textContent = formatCurrency(totalDiscount);
                summaryRow.insertCell(3).textContent = formatCurrency(totalNetSales);
                summaryRow.insertCell(4).textContent = formatCurrency(totalPaidAmount);
                summaryRow.insertCell(5).textContent = formatCurrency(totalNewDueGenerated);

                // Render Details
                monthlyReportDetailBody.innerHTML = '';
                if (monthlyInvoices.length === 0) {
                    monthlyReportDetailBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No invoices found for ${reportMonthSelect.options[reportMonthSelect.selectedIndex].text}, ${selectedYear}.</td></tr>`;
                } else {
                    // Sort by date (oldest first)
                    monthlyInvoices.sort((a, b) => {
                        const [dA, mA, yA] = a.date.split('/').map(Number);
                        const [dB, mB, yB] = b.date.split('/').map(Number);
                        const dateA = new Date(yA, mA - 1, dA);
                        const dateB = new Date(yB, mB - 1, dB);
                        return dateA - dateB;
                    });
                    
                    monthlyInvoices.forEach(invoice => {
                        const detailRow = monthlyReportDetailBody.insertRow();
                        detailRow.insertCell(0).textContent = invoice.date;
                        detailRow.insertCell(1).textContent = invoice.invoiceNo;
                        detailRow.insertCell(2).textContent = invoice.customerName;
                        detailRow.insertCell(3).textContent = formatCurrency(invoice.netSale);
                        detailRow.insertCell(4).textContent = formatCurrency(invoice.discount);
                        
                        const dueCell = detailRow.insertCell(5);
                        dueCell.textContent = formatCurrency(invoice.due);
                        if (invoice.due > 0) {
                            dueCell.classList.add('due-amount-highlight');
                        }
                    });
                }
            }


            // Render All Data
            function renderAllData() {
                hideAllSections();
                showAllDataSection.classList.remove('hidden');

                // Render Current Aggregated Stock
                allCurrentStockTableBody.innerHTML = '';
                const aggregatedStock = {};
                stockData.forEach(item => {
                    const key = `${item.itemName}_${item.itemSize}`;
                    if (aggregatedStock[key]) {
                        aggregatedStock[key].quantity += item.quantity;
                    } else {
                        aggregatedStock[key] = { ...item };
                    }
                });

                for (const key in aggregatedStock) {
                    const item = aggregatedStock[key];
                    const row = allCurrentStockTableBody.insertRow();
                    const itemNameCell = row.insertCell(0);
                    itemNameCell.textContent = item.itemName;
                    itemNameCell.classList.add('item-name-link');
                    itemNameCell.dataset.itemName = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(item.quantity * item.price);
                }

                // Render Stock In Log
                allStockInLogTableBody.innerHTML = '';
                stockInLog.forEach(item => {
                    const row = allStockInLogTableBody.insertRow();
                    const itemNameCell = row.insertCell(1);
                    row.insertCell(0).textContent = item.date;
                    itemNameCell.textContent = item.itemName;
                    itemNameCell.classList.add('item-name-link');
                    itemNameCell.dataset.itemName = item.itemName;
                    row.insertCell(2).textContent = item.itemSize;
                    row.insertCell(3).textContent = item.quantity;
                    row.insertCell(4).textContent = formatCurrency(item.price);
                });

                // Render Stock Out Log
                allStockOutLogTableBody.innerHTML = '';
                stockOutLog.forEach(item => {
                    const row = allStockOutLogTableBody.insertRow();
                    const itemNameCell = row.insertCell(1);
                    row.insertCell(0).textContent = item.date;
                    itemNameCell.textContent = item.itemName;
                    itemNameCell.classList.add('item-name-link');
                    itemNameCell.dataset.itemName = item.itemName;
                    row.insertCell(2).textContent = item.itemSize;
                    row.insertCell(3).textContent = item.quantity;
                    row.insertCell(4).textContent = item.invoiceNo || 'N/A';
                });
            }

            // Function to render individual item report
            function renderItemReport(itemName) {
                hideAllSections();
                itemReportSection.classList.remove('hidden');

                document.getElementById('itemReportName').textContent = itemName;
                document.getElementById('itemReportInName').textContent = itemName;
                document.getElementById('itemReportOutName').textContent = itemName;
                document.getElementById('itemReportCurrentName').textContent = itemName;

                // Populate Stock In for this item
                itemInReportTableBody.innerHTML = '';
                stockInLog.filter(item => item.itemName.toLowerCase() === itemName.toLowerCase())
                        .forEach(item => {
                            const row = itemInReportTableBody.insertRow();
                            row.insertCell(0).textContent = item.date;
                            row.insertCell(1).textContent = item.itemSize;
                            row.insertCell(2).textContent = item.quantity;
                            row.insertCell(3).textContent = formatCurrency(item.price);
                        });

                // Populate Stock Out for this item
                itemOutReportTableBody.innerHTML = '';
                stockOutLog.filter(item => item.itemName.toLowerCase() === itemName.toLowerCase())
                        .forEach(item => {
                            const row = itemOutReportTableBody.insertRow();
                            row.insertCell(0).textContent = item.date;
                            row.insertCell(1).textContent = item.itemSize;
                            row.insertCell(2).textContent = item.quantity;
                            row.insertCell(3).textContent = item.invoiceNo || 'N/A';
                        });

                // Populate Current Stock for this item (aggregated by size)
                itemCurrentReportTableBody.innerHTML = '';
                const itemAggregatedStock = {};
                stockData.filter(item => item.itemName.toLowerCase() === itemName.toLowerCase())
                        .forEach(item => {
                            const key = item.itemSize;
                            if (itemAggregatedStock[key]) {
                                itemAggregatedStock[key].quantity += item.quantity;
                            } else {
                                itemAggregatedStock[key] = { ...item };
                            }
                        });
                for (const key in itemAggregatedStock) {
                    const item = itemAggregatedStock[key];
                    const row = itemCurrentReportTableBody.insertRow();
                    row.insertCell(0).textContent = item.itemSize;
                    row.insertCell(1).textContent = item.quantity;
                    row.insertCell(2).textContent = formatCurrency(item.price);
                }
            }

            // Function to display JSON editor
            function renderJsonEditor() {
                hideAllSections();
                jsonEditorSection.classList.remove('hidden');

                jsonStockDataTextarea.value = JSON.stringify(stockData, null, 2);
                jsonStockInLogTextarea.value = JSON.stringify(stockInLog, null, 2);
                jsonStockOutLogTextarea.value = JSON.stringify(stockOutLog, null, 2);
                jsonCartDataTextarea.value = JSON.stringify(cartItems, null, 2);
                jsonCustomerDataTextarea.value = JSON.stringify(customers, null, 2);
            }

            // Function to save JSON data
            saveStockDataJsonBtn.addEventListener('click', async () => {
                try {
                    const newStockData = JSON.parse(jsonStockDataTextarea.value);
                    if (!Array.isArray(newStockData)) {
                        throw new Error("Parsed data must be an array.");
                    }
                    await saveToFirebase(stockDataRef, newStockData);
                    alert('Stock Data JSON saved successfully!');
                } catch (e) {
                    alert('Error saving Stock Data: ' + e.message + '\nPlease check your JSON format.');
                }
            });

            saveStockInLogJsonBtn.addEventListener('click', async () => {
                try {
                    const newStockInLog = JSON.parse(jsonStockInLogTextarea.value);
                    if (!Array.isArray(newStockInLog)) {
                        throw new Error("Parsed data must be an array.");
                    }
                    await saveToFirebase(stockInLogRef, newStockInLog);
                    alert('Stock In Log JSON saved successfully!');
                } catch (e) {
                    alert('Error saving Stock In Log: ' + e.message + '\nPlease check your JSON format.');
                }
            });

            saveStockOutLogJsonBtn.addEventListener('click', async () => {
                try {
                    const newStockOutLog = JSON.parse(jsonStockOutLogTextarea.value);
                    if (!Array.isArray(newStockOutLog)) {
                        throw new Error("Parsed data must be an array.");
                    }
                    await saveToFirebase(stockOutLogRef, newStockOutLog);
                    alert('Stock Out Log JSON saved successfully!');
                } catch (e) {
                    alert('Error saving Stock Out Log: ' + e.message + '\nPlease check your JSON format.');
                }
            });

            saveCustomerDataJsonBtn.addEventListener('click', async () => {
                try {
                    const newCustomerData = JSON.parse(jsonCustomerDataTextarea.value);
                    if (!Array.isArray(newCustomerData)) {
                        throw new Error("Parsed data must be an array.");
                    }
                    await saveToFirebase(customersRef, newCustomerData);
                    alert('Customer Data JSON saved successfully!');
                } catch (e) {
                    alert('Error saving Customer Data: ' + e.message + '\nPlease check your JSON format.');
                }
            });

            saveCartDataJsonBtn.addEventListener('click', () => {
                try {
                    const newCartData = JSON.parse(jsonCartDataTextarea.value);
                    if (!Array.isArray(newCartData)) {
                        throw new Error("Parsed data must be an array.");
                    }
                    cartItems = newCartData;
                    alert('Cart Data JSON loaded successfully! This data is not saved to the cloud.');
                } catch (e) {
                    alert('Error loading Cart Data: ' + e.message + '\nPlease check your JSON format.');
                }
            });

            // Function to cancel JSON editing
            cancelJsonBtn.addEventListener('click', () => {
                const confirmCancel = confirm("Are you sure you want to cancel? Any unsaved changes will be lost.");
                if (confirmCancel) {
                    renderStockView();
                }
            });

            // --- Cart and Invoice Logic ---
            function renderCartView() {
                hideAllSections();
                cartViewSection.classList.remove('hidden');
                cartTableBody.innerHTML = '';
            
                if (cartItems.length === 0) {
                    cartTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Your cart is empty.</td></tr>`;
                    return;
                }
            
                cartItems.forEach((item, index) => {
                    const row = cartTableBody.insertRow();
                    const subtotal = item.quantity * item.price;
                    row.insertCell(0).textContent = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
            
                    const quantityCell = row.insertCell(2);
                    quantityCell.innerHTML = `<input type="number" value="${item.quantity}" min="1" class="cart-quantity-input" data-index="${index}">`;
            
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(subtotal);
                    const actionCell = row.insertCell(5);
                    actionCell.innerHTML = `
                        <div class="cart-action-buttons">
                            <button class="update-cart" data-index="${index}">Update</button>
                            <button class="remove-from-cart" data-index="${index}">Remove</button>
                        </div>
                    `;
                });
            }

            function renderInvoiceFromCart() {
                hideAllSections();
                sellInvoiceSection.classList.remove('hidden');

                if (cartItems.length === 0) {
                    alert('Your cart is empty. Please add items to the cart before generating an invoice.');
                    renderCartView();
                    return;
                }

                invoiceTableBody.innerHTML = '';
                let totalSubtotal = 0; // Rename local total to subtotal for clarity

                cartItems.forEach((item) => {
                    const row = invoiceTableBody.insertRow();
                    const subtotal = item.quantity * item.price;
                    totalSubtotal += subtotal; // Accumulate subtotal

                    row.insertCell(0).textContent = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(subtotal);
                });
                
                // Set invoice date and generate number
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                invoiceDateDisplay.textContent = `${day}/${month}/${year}`;
                if (!invoiceNoDisplay.textContent || invoiceNoDisplay.textContent.startsWith('INV-')) {
                    invoiceNoDisplay.textContent = generateInvoiceNumber();
                }

                const phone = customerPhoneInput.value.trim();
                const existingCustomer = customers.find(c => c.phone === phone);
                let totalDueForCustomer = 0;

                if (existingCustomer) {
                    customerNameInput.value = existingCustomer.name || '';
                    customerAddressInput.value = existingCustomer.address || '';
                    invoiceCustomerNameDisplay.textContent = existingCustomer.name || 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = existingCustomer.phone || 'N/A';

                    existingCustomer.purchases.forEach(purchase => {
                        totalDueForCustomer += purchase.dueAmount || 0;
                    });
                } else {
                    invoiceCustomerNameDisplay.textContent = 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = 'N/A';
                }

                // Set initial values for NEW Fields
                currentCustomerPreviousDue = totalDueForCustomer;
                customerOutstandingDueOnInvoice.textContent = formatCurrency(currentCustomerPreviousDue);
                previousDueDisplay.textContent = formatCurrency(currentCustomerPreviousDue);
                
                // Reset Discount State
                applyDiscountCheckbox.checked = false;
                discountInputRow.classList.add('hidden');
                discountAmountInput.value = '0';

                // Initialize paid amount (Total Subtotal is default paid)
                paidAmountInput.value = totalSubtotal.toFixed(2);
                
                // Calculate all totals
                calculateDueAmount(); 
            }

            // UPDATED: Function to calculate all totals (Subtotal, Discount, Grand Total, Total Payable, Due)
            function calculateDueAmount() {
                // 1. Subtotal (Gross total of items)
                const subTotalAmount = cartItems.reduce((acc, item) => acc + (item.quantity * item.price), 0);
                invoiceSubTotalDisplay.textContent = formatCurrency(subTotalAmount);
                
                // 2. Apply Discount (Conditional Logic)
                let discountAmount = 0;
                if (applyDiscountCheckbox.checked) {
                    discountAmount = parseFloat(discountAmountInput.value) || 0;
                    if (discountAmount < 0) discountAmount = 0;
                    if (discountAmount > subTotalAmount) discountAmount = subTotalAmount; // Max discount is subtotal
                    discountAmountInput.value = discountAmount.toFixed(2);
                }
                
                // 3. Grand Total (Net total after discount - Current Bill Amount)
                const totalAmountAfterDiscount = Math.max(0, subTotalAmount - discountAmount);
                invoiceTotalDisplay.textContent = formatCurrency(totalAmountAfterDiscount); // This is the amount for current bill

                // 4. Add Previous Due
                const totalPayable = totalAmountAfterDiscount + currentCustomerPreviousDue;
                totalPayableDisplay.textContent = formatCurrency(totalPayable); 

                // 5. Calculate Final Due
                const paidAmount = parseFloat(paidAmountInput.value) || 0;
                let dueAmount = totalPayable - paidAmount;

                if (dueAmount < 0) {
                    dueAmount = 0; // No change return
                }

                dueAmountDisplay.textContent = formatCurrency(dueAmount);

                // Show/Hide Due Row based on total outstanding
                if (dueAmount <= 0) {
                    dueAmountRow.classList.add('hidden');
                } else {
                    dueAmountRow.classList.remove('hidden');
                }
            }


            finalizeSaleBtn.addEventListener('click', async () => {
                if (cartItems.length === 0) {
                    alert('No items in the invoice to finalize. Add items to cart first.');
                    return;
                }

                const confirmSale = confirm('Are you sure you want to finalize this sale and record stock out? This action cannot be undone.');
                if (!confirmSale) {
                    return;
                }

                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const date = `${day}/${month}/${year}`;
                
                const currentInvoiceNo = invoiceNoDisplay.textContent;
                const customerPhone = customerPhoneInput.value.trim();
                const customerName = customerNameInput.value.trim() || 'Guest';
                const customerAddress = customerAddressInput.value.trim() || 'N/A';
                
                // Get All Calculated Totals (Use the current displayed values for accuracy)
                const subTotalAmount = parseFloat(invoiceSubTotalDisplay.textContent.replace(' TK', ''));
                const discountAmount = applyDiscountCheckbox.checked ? parseFloat(discountAmountInput.value) || 0 : 0;
                const totalInvoiceAmount = parseFloat(invoiceTotalDisplay.textContent.replace(' TK', '')); // Grand Total after discount
                const totalPayable = parseFloat(totalPayableDisplay.textContent.replace(' TK', '')); // Grand Total + Previous Due
                const paidAmount = parseFloat(paidAmountInput.value);
                let dueAmount = totalPayable - paidAmount;

                if (dueAmount < 0) {
                    dueAmount = 0;
                }

                if (isNaN(paidAmount) || paidAmount < 0) {
                    alert('Please enter a valid paid amount (non-negative number).');
                    return;
                }
                if (paidAmount > totalPayable) {
                    alert('Paid amount cannot be greater than the Total Payable amount.');
                    return;
                }

                // Create copies to avoid race conditions with the onValue listener
                const newStockData = [...stockData];
                const newStockOutLog = [...stockOutLog];
                const newCustomers = [...customers];


                for (const soldItem of cartItems) {
                    let totalAvailableQuantity = 0;
                    stockData.filter(i =>
                        i.itemName.toLowerCase() === soldItem.itemName.toLowerCase() &&
                        i.itemSize.toLowerCase() === soldItem.itemSize.toLowerCase()
                    ).forEach(i => totalAvailableQuantity += i.quantity);

                    if (totalAvailableQuantity < soldItem.quantity) {
                        alert(`Cannot finalize sale: Not enough stock of "${soldItem.itemName}" (${soldItem.itemSize}). Available: ${totalAvailableQuantity}, Requested: ${soldItem.quantity}. Please adjust cart.`);
                        return;
                    }
                }

                cartItems.forEach(soldItem => {
                    const stockItemIndex = newStockData.findIndex(s =>
                        s.itemName.toLowerCase() === soldItem.itemName.toLowerCase() &&
                        s.itemSize.toLowerCase() === soldItem.itemSize.toLowerCase()
                    );

                    if (stockItemIndex !== -1) {
                        newStockData[stockItemIndex].quantity -= soldItem.quantity;
                        if (newStockData[stockItemIndex].quantity <= 0) {
                            newStockData.splice(stockItemIndex, 1);
                        }
                    }

                    newStockOutLog.push({
                        date: date,
                        itemName: soldItem.itemName,
                        itemSize: soldItem.itemSize,
                        quantity: soldItem.quantity,
                        invoiceNo: currentInvoiceNo
                    });
                });

                if (customerPhone) {
                    let existingCustomer = newCustomers.find(c => c.phone === customerPhone);
                    const purchaseDetails = {
                        invoiceNo: currentInvoiceNo,
                        date: date,
                        items: cartItems.map(item => ({
                            itemName: item.itemName,
                            itemSize: item.itemSize,
                            quantity: item.quantity,
                            unitPrice: item.price,
                            subtotal: item.quantity * item.price
                        })),
                        totalAmount: totalInvoiceAmount, // Grand Total (Net amount after discount)
                        subTotal: subTotalAmount, // NEW: Subtotal before discount
                        discount: discountAmount, // NEW: Discount amount
                        previousDue: currentCustomerPreviousDue, // NEW: Previous due at the time of invoice
                        totalPayable: totalPayable, // NEW: Grand Total + Previous Due
                        paidAmount: paidAmount,
                        dueAmount: dueAmount // NEW: Final Due
                    };

                    if (existingCustomer) {
                        existingCustomer.name = customerName;
                        existingCustomer.address = customerAddress;
                        existingCustomer.purchases.push(purchaseDetails);
                    } else {
                        newCustomers.push({
                            phone: customerPhone,
                            name: customerName,
                            address: customerAddress,
                            purchases: [purchaseDetails]
                        });
                    }
                    await saveToFirebase(customersRef, newCustomers);
                }

                await saveToFirebase(stockDataRef, newStockData);
                await saveToFirebase(stockOutLogRef, newStockOutLog);

                alert('Sale finalized and stock updated!');
                cartItems = [];
                invoiceNoDisplay.textContent = '';
                customerPhoneInput.value = '';
                customerNameInput.value = '';
                customerAddressInput.value = '';
                paidAmountInput.value = '0';
                dueAmountDisplay.textContent = formatCurrency(0);
                invoiceSubTotalDisplay.textContent = formatCurrency(0);
                invoiceTotalDisplay.textContent = formatCurrency(0);
                previousDueDisplay.textContent = formatCurrency(0);
                totalPayableDisplay.textContent = formatCurrency(0);
                customerOutstandingDueOnInvoice.textContent = formatCurrency(0);
                currentCustomerPreviousDue = 0;
                applyDiscountCheckbox.checked = false;
                discountInputRow.classList.add('hidden');
                discountAmountInput.value = '0';

                dueAmountRow.classList.add('hidden');

                renderStockView();
            });


            // --- Customer Section Logic ---
            function renderCustomersList() {
                hideAllSections();
                customersSection.classList.remove('hidden');
                customerListTableBody.innerHTML = '';

                if (customers.length === 0) {
                    const row = customerListTableBody.insertRow();
                    row.insertCell(0).colSpan = 5;
                    row.cells[0].textContent = 'No customers found.';
                    row.cells[0].style.textAlign = 'center';
                    return;
                }

                customers.forEach(customer => {
                    const row = customerListTableBody.insertRow();
                    const phoneCell = row.insertCell(0);
                    phoneCell.textContent = customer.phone;
                    phoneCell.classList.add('customer-name-link');
                    phoneCell.dataset.customerPhone = customer.phone;

                    row.insertCell(1).textContent = customer.name || 'N/A';

                    let totalPurchasesAmount = 0;
                    let totalOutstandingDue = 0;
                    customer.purchases.forEach(purchase => {
                        totalPurchasesAmount += purchase.totalAmount || 0;
                        totalOutstandingDue += purchase.dueAmount || 0;
                    });
                    row.insertCell(2).textContent = formatCurrency(totalPurchasesAmount);

                    const outstandingDueCell = row.insertCell(3);
                    outstandingDueCell.textContent = formatCurrency(totalOutstandingDue);
                    if (totalOutstandingDue > 0) {
                        outstandingDueCell.classList.add('due-amount-highlight');
                    }

                    row.insertCell(4).textContent = customer.purchases.length;
                });
            }

            function renderCustomerReport(customerPhone) {
                hideAllSections();
                customerReportSection.classList.remove('hidden');

                const customer = customers.find(c => c.phone === customerPhone);
                if (!customer) {
                    alert('Customer not found!');
                    renderCustomersList();
                    return;
                }

                customerReportNameSpan.textContent = customer.name || 'N/A';
                customerReportPhoneSpan.textContent = customer.phone;
                customerPurchaseHistoryDiv.innerHTML = '';

                let grandTotalSpent = 0;
                let grandTotalDue = 0;

                if (customer.purchases.length === 0) {
                    customerPurchaseHistoryDiv.innerHTML = '<p>No purchase history for this customer.</p>';
                } else {
                    customer.purchases.sort((a,b) => {
                        // Custom sort for DD/MM/YYYY format dates
                        const [dA, mA, yA] = a.date.split('/').map(Number);
                        const [dB, mB, yB] = b.date.split('/').map(Number);
                        const dateA = new Date(yA, mA - 1, dA);
                        const dateB = new Date(yB, mB - 1, dB);
                        return dateB - dateA; // Descending order (newest first)
                    }).forEach((purchase, purchaseIndex) => {
                        const purchaseDiv = document.createElement('div');
                        purchaseDiv.style.border = '1px solid #ccc';
                        purchaseDiv.style.padding = '10px';
                        purchaseDiv.style.marginBottom = '15px';
                        purchaseDiv.style.borderRadius = '5px';
                        purchaseDiv.style.backgroundColor = '#fefefe';

                        grandTotalSpent += purchase.totalAmount;
                        grandTotalDue += purchase.dueAmount || 0;

                        let dueActionHtml = '';
                        if (purchase.dueAmount > 0) {
                            dueActionHtml = `
                                <br>
                                <strong>Pay Due:</strong>
                                <input type="number" min="0" step="0.01" value="${purchase.dueAmount.toFixed(2)}" class="due-payment-input" id="dueInput_${customerPhone}_${purchaseIndex}">
                                <button class="pay-due-btn" data-customer-phone="${customerPhone}" data-purchase-index="${purchaseIndex}">Record Payment</button>
                            `;
                        }

                        purchaseDiv.innerHTML = `
                            <h4>Invoice No: ${purchase.invoiceNo} (Date: ${purchase.date})</h4>
                            <p>
                                <strong>Subtotal (Gross):</strong> ${formatCurrency(purchase.subTotal || purchase.totalAmount)}<br>
                                <strong>Discount:</strong> ${formatCurrency(purchase.discount || 0)}<br>
                                <strong>Total (Net):</strong> ${formatCurrency(purchase.totalAmount)}<br>
                                <strong>Previous Due:</strong> ${formatCurrency(purchase.previousDue || 0)}<br>
                                <strong>Total Payable:</strong> ${formatCurrency(purchase.totalPayable || purchase.totalAmount + (purchase.previousDue || 0))}<br>
                                <strong>Paid Amount:</strong> ${formatCurrency(purchase.paidAmount || 0)}<br>
                                <strong>Due Amount:</strong> <span class="${purchase.dueAmount > 0 ? 'due-amount-highlight' : ''}">${formatCurrency(purchase.dueAmount || 0)}</span>
                                ${dueActionHtml}
                            </p>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Size</th>
                                        <th>Quantity</th>
                                        <th>Unit Price (TK)</th>
                                        <th>Subtotal (TK)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${purchase.items.map(item => `
                                        <tr>
                                            <td>${item.itemName}</td>
                                            <td>${item.itemSize}</td>
                                            <td>${item.quantity}</td>
                                            <td>${formatCurrency(item.unitPrice)}</td>
                                            <td>${formatCurrency(item.subtotal)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <button class="download-customer-invoice-btn" data-invoice-no="${purchase.invoiceNo}" data-customer-phone="${customerPhone}">Download Invoice (JPEG)</button>
                        `;
                        customerPurchaseHistoryDiv.appendChild(purchaseDiv);
                    });
                }
                customerTotalSpentSpan.textContent = formatCurrency(grandTotalSpent);
                customerTotalDueSpan.textContent = formatCurrency(grandTotalDue);
            }

            // --- Record Due Payment Logic ---
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('pay-due-btn')) {
                    const btn = e.target;
                    const customerPhone = btn.dataset.customerPhone;
                    const purchaseIndex = parseInt(btn.dataset.purchaseIndex);
                    const dueInput = document.getElementById(`dueInput_${customerPhone}_${purchaseIndex}`);
                    const paymentAmount = parseFloat(dueInput.value);

                    if (isNaN(paymentAmount) || paymentAmount <= 0) {
                        alert('Please enter a valid positive amount to pay.');
                        return;
                    }

                    // Create a copy of customers to avoid race conditions
                    const newCustomers = [...customers];
                    const customer = newCustomers.find(c => c.phone === customerPhone);
                    if (!customer || !customer.purchases[purchaseIndex]) {
                        alert('Error: Customer or purchase not found.');
                        return;
                    }

                    const purchase = customer.purchases[purchaseIndex];
                    if (paymentAmount > purchase.dueAmount) {
                        alert(`Payment amount (${formatCurrency(paymentAmount)}) cannot exceed the outstanding due amount (${formatCurrency(purchase.dueAmount)}).`);
                        return;
                    }
                    
                    // Update due/paid logic: preserve previous paid amounts and only update due
                    purchase.paidAmount = (purchase.paidAmount || 0) + paymentAmount;
                    purchase.dueAmount = purchase.dueAmount - paymentAmount;

                    await saveToFirebase(customersRef, newCustomers);
                    alert(`Payment of ${formatCurrency(paymentAmount)} recorded for Invoice ${purchase.invoiceNo}. Remaining Due: ${formatCurrency(purchase.dueAmount)}`);
                    renderCustomerReport(customerPhone);
                }
            });

            // NEW LOGIC: Download Invoice from Customer Report Section
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('download-customer-invoice-btn')) {
                    const btn = e.target;
                    const invoiceNo = btn.dataset.invoiceNo;
                    const customerPhone = btn.dataset.customerPhone;

                    const customer = customers.find(c => c.phone === customerPhone);
                    if (!customer) {
                        alert('Customer not found for this invoice.');
                        return;
                    }

                    const purchase = customer.purchases.find(p => p.invoiceNo === invoiceNo);
                    if (!purchase) {
                        alert('Invoice not found for this customer.');
                        return;
                    }

                    downloadInvoiceDate.textContent = purchase.date;
                    downloadInvoiceNo.textContent = purchase.invoiceNo;
                    downloadCustomerName.textContent = customer.name || 'N/A';
                    downloadCustomerContact.textContent = customer.phone || 'N/A';
                    
                    const now = new Date();
                    const day = String(now.getDate()).padStart(2, '0');
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const year = now.getFullYear();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    generatedDateTime.textContent = `${day}/${month}/${year} ${hours}:${minutes}`;

                    downloadInvoiceTableBody.innerHTML = '';

                    purchase.items.forEach(item => {
                        const row = downloadInvoiceTableBody.insertRow();
                        row.insertCell(0).textContent = item.itemName;
                        row.insertCell(1).textContent = item.itemSize;
                        row.insertCell(2).textContent = item.quantity;
                        row.insertCell(3).textContent = formatCurrency(item.unitPrice);
                        row.insertCell(4).textContent = formatCurrency(item.subtotal);
                    });
                    
                    // NEW FIELDS POPULATION START
                    downloadInvoiceSubTotal.textContent = formatCurrency(purchase.subTotal || purchase.totalAmount || 0);
                    downloadInvoiceDiscount.textContent = formatCurrency(purchase.discount || 0);
                    downloadInvoicePreviousDue.textContent = formatCurrency(purchase.previousDue || 0);
                    downloadInvoiceTotalPayable.textContent = formatCurrency(purchase.totalPayable || purchase.totalAmount + (purchase.previousDue || 0));
                    // NEW FIELDS POPULATION END

                    downloadInvoiceTotal.textContent = formatCurrency(purchase.totalAmount);
                    downloadInvoicePaid.textContent = formatCurrency(purchase.paidAmount);
                    downloadInvoiceDue.textContent = formatCurrency(purchase.dueAmount);

                    const downloadDueDiv = downloadableInvoiceDiv.querySelector('#downloadInvoiceDue').closest('div');
                    if (purchase.dueAmount <= 0) {
                        downloadDueDiv.classList.add('hidden');
                    } else {
                        downloadDueDiv.classList.remove('hidden');
                    }
                    downloadableInvoiceDiv.querySelector('#downloadInvoicePaid').closest('div').classList.remove('hidden');


                    downloadableInvoiceDiv.style.position = 'absolute';
                    downloadableInvoiceDiv.style.left = '-9999px';
                    downloadableInvoiceDiv.style.top = '-9999px';
                    downloadableInvoiceDiv.classList.remove('hidden');

                    try {
                        if (typeof html2canvas === 'undefined') {
                            console.error("html2canvas library not loaded. Please check the CDN link.");
                            alert("Error: Image generation library not loaded. Cannot download invoice.");
                            return;
                        }

                        const canvas = await html2canvas(downloadableInvoiceDiv, {
                            scale: 2,
                            useCORS: true,
                            logging: true,
                            onclone: (document) => {
                                document.querySelector('#downloadableInvoice .invoice-logo').style.display = 'block';
                                document.querySelector('#downloadableInvoice #downloadInvoicePaid').closest('div').classList.remove('hidden');
                                const clonedDueAmount = parseFloat(document.getElementById('downloadInvoiceDue').textContent.replace(' TK', '')) || 0;
                                if (clonedDueAmount <= 0) {
                                    document.querySelector('#downloadableInvoice #downloadInvoiceDue').closest('div').classList.add('hidden');
                                } else {
                                    document.querySelector('#downloadableInvoice #downloadInvoiceDue').closest('div').classList.remove('hidden');
                                }
                            }
                        });

                        const imageDataURL = canvas.toDataURL('image/jpeg', 0.9);

                        const link = document.createElement('a');
                        link.href = imageDataURL;
                        link.download = `Invoice_${purchase.invoiceNo}_${customer.name || 'Customer'}.jpeg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        alert('Invoice downloaded successfully!');

                    } catch (error) {
                        console.error('Error generating invoice image:', error);
                        alert('Failed to generate invoice image. Please check the console for details and ensure all content is properly rendered. This could be due to a "tainted canvas" issue if external content (like images from another domain) is present.');
                    } finally {
                        downloadableInvoiceDiv.classList.add('hidden');
                        downloadableInvoiceDiv.style.position = '';
                        downloadableInvoiceDiv.style.left = '';
                        downloadableInvoiceDiv.style.top = '';
                    }
                }
            });


            // --- Event Listeners for Cart Actions ---
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('update-cart')) {
                    const index = e.target.dataset.index;
                    const newQuantity = parseInt(document.querySelector(`.cart-quantity-input[data-index="${index}"]`).value);
            
                    if (isNaN(newQuantity) || newQuantity <= 0) {
                        alert('Please enter a valid quantity.');
                        renderCartView(); // Re-render to show original value
                        return;
                    }
            
                    const item = cartItems[index];
                    const totalAvailableQuantity = stockData.filter(s => 
                        s.itemName.toLowerCase() === item.itemName.toLowerCase() && 
                        s.itemSize.toLowerCase() === item.itemSize.toLowerCase()
                    ).reduce((acc, s) => acc + s.quantity, 0);
            
                    if (newQuantity > totalAvailableQuantity) {
                        alert(`Not enough stock of "${item.itemName}" (${item.itemSize}). Available: ${totalAvailableQuantity}.`);
                        renderCartView(); // Re-render to show original value
                        return;
                    }
            
                    item.quantity = newQuantity;
                    renderCartView();
                }
            
                if (e.target.classList.contains('remove-from-cart')) {
                    const index = e.target.dataset.index;
                    cartItems.splice(index, 1);
                    renderCartView();
                }
            });

            clearCartBtn.addEventListener('click', () => {
                const confirmClear = confirm('Are you sure you want to clear your cart?');
                if (confirmClear) {
                    cartItems = [];
                    renderCartView();
                }
            });

            // --- NEW: Dynamic Calculation & Conditional Discount Display ---
            applyDiscountCheckbox.addEventListener('change', () => {
                if (applyDiscountCheckbox.checked) {
                    discountInputRow.classList.remove('hidden');
                } else {
                    discountInputRow.classList.add('hidden');
                    discountAmountInput.value = '0'; 
                }
                calculateDueAmount(); 
            });

            discountAmountInput.addEventListener('input', calculateDueAmount);
            paidAmountInput.addEventListener('input', calculateDueAmount);
            downloadInvoicePdfBtn.addEventListener('click', () => {
                alert('The PDF generation feature is still under construction! Please use the JPEG download button on the Customer Report for now, which uses the same data.');
            });


            // --- Event Listeners for Navigation Buttons ---
            btnStockView.addEventListener('click', renderStockView);
            btnStockEntry.addEventListener('click', () => { hideAllSections(); stockEntrySection.classList.remove('hidden'); });
            btnStockOut.addEventListener('click', () => { hideAllSections(); stockOutSection.classList.remove('hidden'); });
            btnShowAllData.addEventListener('click', renderAllData);
            btnJsonEdit.addEventListener('click', renderJsonEditor);
            btnSellInvoice.addEventListener('click', renderCartView); // Go to cart view first
            goToInvoiceBtn.addEventListener('click', renderInvoiceFromCart); // New button for going from cart to invoice
            backToCartBtn.addEventListener('click', renderCartView);
            btnCustomers.addEventListener('click', renderCustomersList);
            btnOverallReport.addEventListener('click', renderOverallReport);
            btnMonthlyReport.addEventListener('click', renderMonthlyReportSection); // NEW
            generateMonthlyReportBtn.addEventListener('click', generateMonthlyReport); // NEW
            backToAllDataBtn.addEventListener('click', renderAllData);
            backToCustomersListBtn.addEventListener('click', renderCustomersList);

            // Event listener for clicking on item names in "Show All Data"
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('item-name-link')) {
                    const itemName = e.target.dataset.itemName;
                    if (itemName) {
                        renderItemReport(itemName);
                    }
                } else if (e.target.classList.contains('customer-name-link')) {
                    const customerPhone = e.target.dataset.customerPhone;
                    if (customerPhone) {
                        renderCustomerReport(customerPhone);
                    }
                }
            });

            customerPhoneInput.addEventListener('input', () => {
                const phone = customerPhoneInput.value.trim();
                const existingCustomer = customers.find(c => c.phone === phone);
                let totalDue = 0;

                if (existingCustomer) {
                    customerNameInput.value = existingCustomer.name || '';
                    customerAddressInput.value = existingCustomer.address || '';
                    invoiceCustomerNameDisplay.textContent = existingCustomer.name || 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = existingCustomer.phone || 'N/A';

                    existingCustomer.purchases.forEach(purchase => {
                        totalDue += purchase.dueAmount || 0;
                    });
                } else {
                    if (!customerNameInput.dataset.userEdited) {
                        customerNameInput.value = '';
                    }
                    if (!customerAddressInput.dataset.userEdited) {
                        customerAddressInput.value = '';
                    }
                    invoiceCustomerNameDisplay.textContent = phone ? phone : 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = phone ? phone : 'N/A';
                }
                customerOutstandingDueOnInvoice.textContent = formatCurrency(totalDue);
                currentCustomerPreviousDue = totalDue; // Update global variable
                calculateDueAmount(); // Recalculate invoice based on new customer due
            });

            customerNameInput.addEventListener('input', () => {
                customerNameInput.dataset.userEdited = 'true';
                invoiceCustomerNameDisplay.textContent = customerNameInput.value.trim() || 'N/A';
            });
            customerAddressInput.addEventListener('input', () => {
                customerAddressInput.dataset.userEdited = 'true';
            });
            
            // Initial call to set current month/year on load
            initializeYearDropdown(); 
        });
    </script>
</body>
</html>

