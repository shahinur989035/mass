<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Apparel Style Solution - Stock & Sales Management (Optimized)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            padding-top: 100px !important;
            padding-bottom: 85px !important;
        }
        
        /* Fixed Header Styling */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            background: linear-gradient(135deg, #f0fdff 0%, #fffccc 100%);
            border-bottom: 2px solid #ddd;
            border-radius: 0 0 20px 20px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
         
        .header-logo {
            max-width: 60px;
            height: auto;
            margin-right: 10px;
        }

        .header-text {
            text-align: left;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .header-text h3 {
            margin: 0;
            color: #244850;
            font-size: 22px;
        }

        .header-text h4 {
            margin: 3px 0;
            color: #555;
            font-size: 12px;
        }

        /* Fixed Navigation Styling - IMPROVED */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 9999;
            padding: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }

        nav::-webkit-scrollbar {
            display: none;
        }

        /* ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .modern-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none !important;
            border: none !important;
            color: #555 !important;
            cursor: pointer;
            flex: 1;
            min-width: 30px;
            padding: 5px 0 !important;
            transition: all 0.3s ease;
        }

        .modern-btn.active {
            color: #007bff !important;
        }

        .modern-btn.active i {
            color: #007bff !important;
        }

        /* ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∏‡¶æ‡¶á‡¶ú */
        .modern-btn i {
            font-size: 25px !important;
            margin-bottom: 3px !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü */
        .modern-btn span {
            font-size: 10px !important;
            font-weight: 600;
        }

        /* ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® */
        .modern-btn:active {
            transform: scale(0.9);
            color: #007bff !important;
        }

        /* ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ */
        #btnDashboard { color: #244850 !important; }
        #btnStockView { color: #5cb85c !important; }
        #btnStockEntry { color: #007bff !important; }
        #btnSellInvoice { color: #20c997 !important; }
        #btnCustomers { color: #6f42c1 !important; }
        #btnMonthlyReport { color: #ffc107 !important; }
        #btnOverallDataView { color: #dc3545 !important; }

        /* Cart count badge */
        .cart-count-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 9px;
            margin-left: 3px;
        }

        /* Main Content Styling */
        main {
            position: relative;
            width: 100%;
            min-height: calc(100vh - 180px);
            border-radius: 20px;
            padding: 1px;
            margin-top: 10px;
            box-sizing: border-box;
            background: #ecf0f3;
            box-shadow: 14px 14px 20px #cbced1, -14px -14px 20px white;
            overflow-y: auto;
        }

        /* Initially hide all sections */
        main > section {
            display: none;
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        main > section:not(.hidden) {
            display: block;
        }
        
        /* Dashboard Section */
        #dashboardSection {
            display: block;
            padding: 20px;
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card i {
            font-size: 30px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 25%;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .card-icon-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-icon-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .card-icon-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .card-icon-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .card-content {
            flex: 1;
            text-align: center;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: darkorange;
            margin-bottom: 5px;
        }
        
        .card-value1 {
           font-size: 24px;
           font-weight: bold;
           color: red;
           margin-bottom: 5px;
        }
        
        .card-value2 {
            font-size: 24px;
            font-weight: bold;
            color: green;
            margin-bottom: 5px;
        }
        
        .card-label {
            font-size: 10px;
            color: #666;
        }
        
        /* New Pie Chart Styles - UPDATED */
        .pie-chart-container {
            width: 60px;
            height: 60px;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
        }

        .pie-chart {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .pie-segment {
            fill: none;
            stroke-width: 32;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .pie-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            
            font-weight: bold;
            color: #333;
            text-align: center;
            background: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Pie Chart Item Labels Inside Pie */
        .item-label {
            position: absolute;
            font-size: 5px !important;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            pointer-events: none;
            white-space: nowrap;
            transform-origin: center;
            z-index: 2;
        }

        /* Pie Chart Outer Text - Total Stock Quantity */
        .pie-outer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: bold;
            color: darkorange;
            text-align: center;
            pointer-events: none;
            z-index: 1;
            margin-top: 85px;
        }

        /* Color classes for different items */
        .color-item-1 { background-color: #667eea; }
        .color-item-2 { background-color: #f093fb; }
        .color-item-3 { background-color: #4facfe; }
        .color-item-4 { background-color: #43e97b; }
        .color-item-5 { background-color: #ffc107; }
        .color-item-6 { background-color: #dc3545; }
        .color-item-7 { background-color: #6f42c1; }
        .color-item-8 { background-color: #20c997; }
        .color-item-9 { background-color: #17a2b8; }
        .color-item-10 { background-color: #fd7e14; }
        
        /* SVG stroke colors */
        .stroke-color-1 { stroke: #667eea; }
        .stroke-color-2 { stroke: #f093fb; }
        .stroke-color-3 { stroke: #4facfe; }
        .stroke-color-4 { stroke: #43e97b; }
        .stroke-color-5 { stroke: #ffc107; }
        .stroke-color-6 { stroke: #dc3545; }
        .stroke-color-7 { stroke: #6f42c1; }
        .stroke-color-8 { stroke: #20c997; }
        .stroke-color-9 { stroke: #17a2b8; }
        .stroke-color-10 { stroke: #fd7e14; }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            background: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .action-btn:hover {
            background: #f8f9fa;
            transform: translateY(-3px);
        }
        
        .action-btn i {
            font-size: 24px;
            color: #007bff;
        }
        
        .action-btn span {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        
        /* Section Header */
        h2 {
            color: seagreen;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Stock Summary */
        .stock-summary {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        /* üé® Universal Table Styling (APPLIED TO ALL TABLES EXCEPT DOWNLOADABLE INVOICE) */
        table:not(#downloadableInvoice table) {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        table:not(#downloadableInvoice table) th, table:not(#downloadableInvoice table) td {
            width: auto;
            border: 2px solid #eee;
            padding: 8px 5px;
            text-align: center;
            font-size: 11px;
        }
        table:not(#downloadableInvoice table) th {
            background-color: #ffffe0b2;
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }
        
        /* Zebra Stripping: Alternating row colors for all tables (EXCEPT DOWNLOADABLE INVOICE) */
        table:not(#downloadableInvoice table) tbody tr:nth-child(even) { 
            background-color: #f7f7f7;
        }
        table th {
            font-weight: 600;
            font-size: 13px;
            padding: 15px 10px;
            text-align: center;
            border: none;
            position: relative;
        }

        /* Hover effect for better usability (EXCEPT DOWNLOADABLE INVOICE) */
        table:not(#downloadableInvoice table) tbody tr:hover {
            background-color: #eef;
        }

        /* Add to Cart icon style */
        .add-to-cart-icon {
            background: none;
            border: none;
            color: #28a745;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .add-to-cart-icon:hover {
            transform: scale(1.2);
            color: #218838;
        }

        /* Form Styling (simplified) */
        form {
            
            padding: 20px;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            color: #000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        .due-amount-highlight {
            color: red;
            font-weight: bold;
        }
        .payable-amount-highlight {
            color: green;
            font-weight: bold;
        }

        /* Cart Summary Cards */
        .cart-summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .summary-card i {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }

        .summary-card.stock-value i {
            background: #28a745;
        }

        .summary-card.due-amount i {
            background: #dc3545;
        }

        .summary-card.cart-total i {
            background: #007bff;
        }

        .summary-content {
            flex: 1;
        }

        /* Cart Table Improvements - FIXED QUANTITY INPUT */
        .cart-quantity-input {
            width: 70px !important;
            padding: 8px !important;
            text-align: center;
            font-size: 14px !important;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 auto;
            display: block;
        }

        .cart-action-buttons {
            display: flex;
            gap: 5px;
        }

        .cart-action-buttons button {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .remove-from-cart {
            background: #dc3545;
            color: white;
        }

        /* Modal for Invoice Editing */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #saveInvoiceBtn {
            background: #28a745;
            color: white;
        }

        #cancelEditBtn {
            background: #6c757d;
            color: white;
        }

        /* Invoice Edit Table */
        #editableInvoiceTable input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }

        #editableInvoiceTable td {
            padding: 5px;
        }

        .remove-item-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* üé® DOWNLOADABLE INVOICE SPECIFIC STYLES */
        #invoiceContainer .invoice-logo {
            max-width: 100px;
            height: auto;
            margin: 0 auto 10px auto;
            display: block !important; 
        }
        
        #invoiceContainer h3 {
            text-align: center;
            font-size: 24px;
            color: #244850;
            margin-bottom: 20px;
        }
        
        /* Customer Details Form */
        #customerDetailsForm {
            width: 90%;
            max-width: 400px;
            margin: 0px auto 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #customerDetailsForm input[type="text"], 
        #customerDetailsForm input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #customerDetailsForm label { 
            display: block;
            margin-bottom: 5px; 
            font-weight: bold; 
            width: 100%;
        }

        #downloadableInvoice {
            position: relative; 
            overflow: hidden; 
            padding: 30px;
            margin: 20px auto;
            border: 2px solid #ccc;
            background-color: #fff;
            max-width: 800px; 
            box-sizing: border-box;
            font-size: 15px;
        }
        
        /* CRITICAL: Styles for the TABLE inside the downloadable invoice */
        #downloadableInvoice table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: none;
            background-color: transparent;
        }
        
        #downloadableInvoice table th, #downloadableInvoice table td {
            width: auto;
            border: 1px solid #ccc;
            padding: 8px 5px;
            text-align: center;
            font-size: 13px;
        }
        
        #downloadableInvoice table th {
            background-color: #eee;
            font-weight: bold;
            color: #333;
            font-size: 11px;
        }

        /* Watermark Logo Styling */
        .invoice-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); 
            width: 70%; 
            height: auto;
            margin-top: 30px;
            opacity: 0.1; 
            z-index: 0; 
            pointer-events: none;
        }

        #downloadableInvoice .invoice-logo {
            display: none; 
        }

        /* ‡¶®‡¶§‡ßÅ‡¶® Flex Header ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .download-invoice-header {
            display: flex;
            align-items: center; 
            justify-content: center; 
            margin-bottom: 30px; 
            margin-top: 15px; 
            position: relative; 
            z-index: 1;
        }

        .download-invoice-header .invoice-logo {
            max-width: 80px;
            height: auto;
            margin: 0 10px 0 0;
            display: block !important;
        }

        .download-invoice-header h1 {
            text-align: left; 
            color: #244950;
            margin: 0; 
            font-size: 18px;
            line-height: 1.2;
            padding-top: 5px; 
        }
        
        #downloadableInvoice h1 {
            font-size: 25px;
            text-align: center;
        }

        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .invoice-details strong {
            display: inline-block;
            width: 120px;
        }
        .invoice-total-summary {
            text-align: right;
            margin-top: 20px;
            position: relative;
            z-index: 1;
            font-size: 17px;
            
        }
        .invoice-total-summary div {
            padding: 5px 0;
            font-weight: bold;
            
        }
        .invoice-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            text-align: center;
            font-size: 12px;
            color: #666;
            position: relative;
            z-index: 1;
        }

        /* Existing Styles from user provided code (continued) */
        form label { display: inline-block; margin-bottom: 8px; font-weight: bold; width: 120px; }
        form input[type="text"], form input[type="number"] { width: calc(100% - 130px); padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        form button[type="submit"] { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 8px; margin-top: 10px; }
        .item-name-link, .customer-name-link { color: #007bff; text-decoration: underline; cursor: pointer; }
        #jsonEditorSection textarea { width: 100%; height: 250px; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        #invoiceContainer { border: 1px solid #ccc; padding: 20px; margin-top: 20px; background-color: #fefefe; border-radius: 8px; }
        #invoiceTable th, #invoiceTable td { border: 1px solid #eee; padding: 10px; text-align: left; }
        #invoiceTable tfoot td { font-weight: bold; font-size: 13px; background-color: #f2f2f2; }
        #invoiceActions { text-align: right; margin-top: 15px; }
        #finalizeSaleBtn { background-color: #007bff; color: white; }
        #clearInvoiceBtn { background-color: #dc3545; color: white; }
        .add-to-cart-form { 
            display: flex; align-items: center; gap: 5px; margin-top: 1px; }
        .add-to-cart-form input[type="number"] { width: 30px; height: 10px; margin-bottom: 0; padding: 5px; box-sizing: border-box; }
        .add-to-cart-form button { background-color: #17a2b8; color: white; padding: 3px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin-top: 0; }
        .cart-checkout-buttons { text-align: right; margin-top: 20px; }
        #goToInvoiceBtn { background-color: #28a745; color: white; }
        #clearCartBtn { background-color: #dc3545; color: white; }
        .pay-due-btn, .download-customer-invoice-btn { background-color: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin-top: 5px; margin-right: 5px; }
        .download-customer-invoice-btn { background-color: #ffc107; color: #333; }
        
        /* UPDATED: Monthly Report Controls - Single Date Range Picker */
        #monthlyReportControls { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            background-color: #f8f9fa; 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .date-range-picker-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #28a745;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        
        .date-range-picker-container label {
            font-weight: bold;
            color: #244850;
            margin: 0;
            white-space: nowrap;
        }
        
        #dateRangeInput {
            padding: 10px 12px;
            border: 1px solid #28a745;
            border-radius: 5px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
            text-align: center;
        }
        
        .date-range-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #244850;
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            min-width: 300px;
        }
        
        .date-range-display span {
            padding: 5px 10px;
            border-radius: 4px;
            background: white;
            border: 1px solid #ddd;
        }
        
        .date-range-separator {
            color: #28a745;
            font-weight: bold;
            font-size: 18px;
        }
        
        #setDateRangeBtn {
            padding: 10px 25px;
            border-radius: 5px;
            border: 1px solid #ffc107;
            background: #ffc107;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        #setDateRangeBtn:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .preview-highlight {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
        
        /* New Styles for Stock Entry Form */
        .stock-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stock-form-actions button {
            flex: 1;
            padding: 10px;
            font-size: 12px;
        }
        
        #addStockBtn {
            background-color: #28a745;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            border-radius: 5px;
    font-size: 16px;
            
        }
        
        #removeStockBtn {
            background-color: #dc3545;
            color: white;
            border-radius: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 16px;
        }
        
        /* Customer Edit Form Styles */
        .customer-edit-form {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .customer-edit-form h4 {
            margin-top: 0;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .customer-edit-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            width: 100%;
        }
        
        .customer-edit-form input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .customer-edit-form .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .customer-edit-form .form-buttons button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .save-customer-btn {
            background-color: #28a745;
            color: white;
        }
        
        .cancel-edit-btn {
            background-color: #6c757d;
            color: white;
        }
        
        /* Button Styles */
        .edit-customer-btn {
            background-color: #17a2b8;
            color: white;
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin: 2px;
        }
        
        .edit-customer-btn:hover {
            background-color: #138496;
        }
        
        /* Animation for cart addition */
        @keyframes cartAdd {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .cart-add-animation {
            animation: cartAdd 0.5s ease-in-out;
        }
        
        /* Quantity input in cart - FIXED */
        .cart-quantity-input {
            width: 60px !important;
            padding: 8px !important;
            text-align: center;
            font-size: 14px !important;
            border: 2px solid #007bff !important;
            border-left: none !important;
            border-right: none !important;
            border-radius: 0 !important;
            background-color: white;
            font-weight: bold;
        }
        
        .cart-quantity-input:focus {
            outline: none;
            border-color: #0056b3 !important;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        
        /* Quantity control buttons */
        .quantity-btn {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .quantity-btn.plus {
            background: #28a745;
            border-radius: 0 4px 4px 0;
        }
        
        .quantity-btn.minus {
            background: #dc3545;
            border-radius: 4px 0 0 4px;
        }
        
        /* Quantity control container */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0;
            justify-content: center;
        }
        
        /* Table containers for scrollable areas - ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶ø‡¶Ç ‡¶õ‡¶æ‡ßú‡¶æ */
        .table-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            position: relative;
            overflow: visible; /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ */
        }
        
        .table-container table {
            margin-top: 0;
        }
        
        /* NEW: Purchase invoice card styling for better visibility */
        .purchase-invoice-card {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #fefefe;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .purchase-invoice-card h4 {
            margin-top: 0;
            color: #244850;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        /* NEW: Improved invoice view */
        .invoice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .invoice-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Scrollable content - ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶ø‡¶Ç ‡¶õ‡¶æ‡ßú‡¶æ */
        .scrollable-content {
            position: relative;
            overflow: visible; /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ */
        }
        
        #backToAllData,#backToCustomersList{
            background: blue;
            border-radius: 10px;
            color: whitesmoke;
            height: 30px;
        box-shadow:inset 0 1px 0 #FFE5C4, inset 0 -3px 0 #915100;
        }
        
        /* ‡¶®‡¶§‡ßÅ‡¶®: ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .tab-navigation {
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin: 20px 0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background: #e9ecef;
            color: #495057;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .tab-btn:hover {
            background: #dee2e6;
            transform: translateY(-2px);
        }
        
        .tab-btn.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 5px rgba(0,123,255,0.3);
        }
        
        .tab-content-container {
            position: relative;
            min-height: 400px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    
    <header>
        <div class="main-header">
            <img src="img.png" alt="Modern Apparel Style Solutian Logo" class="header-logo">
            <div class="header-text">
                <h3>Modern Apparel Style Solution (MASS)</h3>
                <h4>Stock Management System</h4>
            </div>
        </div>
        
    <nav>
        <button id="btnDashboard" class="modern-btn"><i class="fa-solid fa-home"></i><span>Dashboard</span></button>
        <button id="btnStockView" class="modern-btn"><i class="fa-solid fa-layer-group"></i><span>Stock</span></button>
        <button id="btnStockEntry" class="modern-btn"><i class="fa-solid fa-circle-plus"></i><span>Entry</span></button>
        <button id="btnSellInvoice" class="modern-btn"><i class="fa-solid fa-file-invoice"></i><span>Invoice</span></button>
        <button id="btnCustomers" class="modern-btn"><i class="fa-solid fa-user-group"></i><span>Customers</span></button>
        <button id="btnMonthlyReport" class="modern-btn"><i class="fa-solid fa-calendar-check"></i><span>Monthly</span></button>
        <button id="btnOverallDataView" class="modern-btn"><i class="fa-solid fa-database"></i><span>All Data</span></button>
    </nav>

    </header>

    <main id="content">
        <!-- Dashboard Section (Default View) -->
        <section id="dashboardSection">
            <h2>Dashboard Overview</h2>
            
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <i class="fas fa-boxes card-icon-1"></i>
                    <div class="card-content">
                        <div class="card-value2" id="dashboardStockValue">0.00 TK</div>
                        <div class="card-label">Total Stock Value</div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <i class="fas fa-users card-icon-2"></i>
                    <div class="card-content">
                        <div class="card-value1" id="dashboardCustomerDue">0.00 TK</div>
                        <div class="card-label">Customer Outstanding Due</div>
                    </div>
                </div>
                
                <!-- Pie Chart Card (Updated) -->
                <div class="dashboard-card">
                    <div class="pie-chart-container">
                        <svg id="stockPieChart" class="pie-chart" viewBox="0 0 32 32">
                            <!-- Pie chart segments will be added dynamically -->
                        </svg>
                        <div class="pie-center-text" id="pieChartTotal">0</div>
                        <!-- Item labels will be added dynamically -->
                        <!-- Outer text for total stock quantity -->
                        <div class="pie-outer-text" id="pieOuterTotal">0</div>
                    </div>
                    <div class="card-content">
                        <div class="card-value" id="pieChartLabel">0</div>
                        <div class="card-label">Total Stock Quantity</div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <i class="fas fa-shopping-cart card-icon-4"></i>
                    <div class="card-content">
                        <div class="card-value" id="dashboardCartItems">0</div>
                        <div class="card-label">Items in Cart</div>
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <button class="action-btn" id="quickStockView">
                    <i class="fas fa-layer-group"></i>
                    <span>View Stock</span>
                </button>
                
                <button class="action-btn" id="quickStockEntry">
                    <i class="fas fa-circle-plus"></i>
                    <span>Add Stock</span>
                </button>
                
                <button class="action-btn" id="quickSell">
                    <i class="fas fa-file-invoice"></i>
                    <span>Create Invoice</span>
                </button>
                
                <button class="action-btn" id="quickCustomers">
                    <i class="fas fa-user-group"></i>
                    <span>Manage Customers</span>
                </button>
            </div>
            

        </section>

        <section id="stockViewSection" class="hidden">
            <h2 id="h2">Current Stock Data</h2>
            
            <!-- Stock Summary -->
            <div class="stock-summary">
                <div class="summary-item">
                    <span class="summary-label">Total Items:</span>
                    <span class="summary-value" id="totalItemsCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total Quantity:</span>
                    <span class="summary-value" id="totalQuantity">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total Value:</span>
                    <span class="summary-value" id="totalStockValueMain">0.00 TK</span>
                </div>
            </div>
          
            <table id="currentStockTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Available</th>
                        <th>Price</th>
                        <th>Total Value</th>
                        <th>Add to Cart</th>
                    </tr>
                </thead>
                <tbody>
                     
                </tbody>
            </table>
        </section>

        <section id="stockEntrySection" class="hidden">
            <h2>Stock Entry</h2>
            <form id="stockEntryForm">
                <label for="entryItemName">Item Name:</label>
                <input type="text" id="entryItemName" required><br><br>

                <label for="entryItemSize">Size:</label>
                <input type="text" id="entryItemSize" required><br><br>

                <label for="entryQuantity">Quantity:</label>
                <input type="number" id="entryQuantity" min="1" required><br><br>

                <label for="entryPrice">Price (per unit) (TK):</label>
                <input type="number" id="entryPrice" min="0" step="0.01" required><br><br>

                <div class="stock-form-actions">
                    <button type="button" id="addStockBtn">Add Stock</button>
                    <button type="button" id="removeStockBtn">Remove Stock</button>
                </div>
            </form>
        </section>

        <section id="overallDataViewSection" class="hidden">
            <h2>Overall Data View</h2>
            
            <h3>Current Aggregated Stock:</h3>
            <table id="allCurrentStockTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                        <th>Total Value (TK)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h3>Stock In Log:</h3>
            <table id="allStockInLogTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h3>Stock Out Log:</h3>
            <table id="allStockOutLogTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Invoice No</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </section>

        <section id="itemReportSection" class="hidden">
            <h2>Item Specific Report: <span id="itemReportName"></span></h2>
            <button id="backToAllData">Back to All Data</button>
            <h3>Stock In for <span id="itemReportInName"></span>:</h3>
            <table id="itemInReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h3>Stock Out for <span id="itemReportOutName"></span>:</h3>
            <table id="itemOutReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Invoice No</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h3>Current Stock for <span id="itemReportCurrentName"></span>:</h3>
            <table id="itemCurrentReportTable">
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Price (per unit) (TK)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
        
        <section id="cartViewSection" class="hidden">
            <h2>Your Cart</h2>
            
            <!-- Cart Summary Cards -->
            <div class="cart-summary-cards">
               
                <div class="summary-card cart-total">
                    <i class="fas fa-shopping-cart"></i>
                    <div class="summary-content">
                        <span class="summary-label">Cart Total</span>
                        <span class="summary-value" id="cartTotalValue">0.00 TK</span>
                    </div>
                </div>
            </div>
            
            <table id="cartTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Unit Price (TK)</th>
                        <th>Subtotal (TK)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                </tbody>
            </table>
            <div class="cart-checkout-buttons">
                <button id="goToInvoiceBtn">Go to Invoice</button>
                <button id="clearCartBtn">Clear Cart</button>
            </div>
        </section>

        <section id="sellInvoiceSection" class="hidden">
            <h2>Generate Invoice from Cart</h2>
            <p>Items in this invoice are pulled directly from your cart.</p>

            <div id="invoiceContainer">
                <img src="img.png" alt="MASS Company Logo" class="invoice-logo">
                <h3>Invoice</h3>
                <div id="customerDetailsForm">
                    <p>Enter Customer Details (Optional for direct sale):</p>
                    <label for="customerPhone">Phone Number:</label>
                    <input type="text" id="customerPhone" placeholder="e.g., 01XXXXXXXXX"><br>
                    <label for="customerName">Customer Name:</label>
                    <input type="text" id="customerName" placeholder="e.g., Customer Name"><br>
                    <label for="customerAddress">Address:</label>
                    <input type="text" id="customerAddress" placeholder="e.g., 123 Main St"><br>
                </div>
                <div class="invoice-details">
                    <div>
                        <strong>Invoice Date:</strong> <span id="invoiceDateDisplay"></span><br>
                        <strong>Invoice No:</strong> <span id="invoiceNoDisplay"></span><br>
                        <strong>Customer:</strong> <span id="invoiceCustomerName">N/A</span> (<span id="invoiceCustomerPhone">N/A</span>)
                    </div>
                    <div style="text-align: right;">
                      
                        <strong>Customer Outstanding Due:</strong> <span id="customerOutstandingDueOnInvoice" class="due-amount-highlight">0.00 TK</span>
                    </div>
                </div>
                <table id="invoiceTable">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Size</th>
                            <th>Quantity</th>
                            <th>Unit Price (TK)</th>
                            <th>Subtotal (TK)</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Subtotal (Current Bill):</strong></td>
                            <td id="invoiceSubTotal">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Apply Discount?</strong></td>
                            <td colspan="2" style="text-align: left;">
                                <input type="checkbox" id="applyDiscountCheckbox" style="margin-right: 5px;"> **Discount**
                            </td>
                        </tr>
                        
                        <tr id="discountInputRow" class="hidden">
                            <td colspan="3" style="text-align: right;"><strong>Discount Amount (TK):</strong></td>
                            <td colspan="2">
                                <input type="number" id="discountAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 5px; box-sizing: border-box;">
                            </td>
                        </tr>
                        
                        <tr id="invoiceTotalRow" class="hidden">
                            <td colspan="4" style="text-align: right;">**Grand Total (Net Amount / ‡¶™‡ßç‡¶∞‡¶¶‡ßá‡¶Ø‡¶º ‡¶¨‡¶ø‡¶≤):**</td>
                            <td id="invoiceTotal">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Customer's Previous Due (TK):</strong></td>
                            <td id="previousDueDisplay" class="due-amount-highlight">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="4" style="text-align: right;">**Total Payable (Net + Previous) (TK):**</td>
                            <td id="totalPayableDisplay" class="due-amount-highlight">0.00 TK</td>
                        </tr>
                        
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Paid Amount (TK):</strong></td>
                            <td colspan="2">
                                <input type="number" id="paidAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 5px; box-sizing: border-box;">
                            </td>
                        </tr>
                        
                        <tr id="dueAmountRow">
                            <td colspan="4" style="text-align: right;">**Total Outstanding Due (TK):**</td>
                            <td id="dueAmountDisplay" class="due-amount-highlight">0.00 TK</td>
                        </tr>
                    </tfoot>
                    </table>
                <div id="invoiceActions">
                    <button id="finalizeSaleBtn">Finalize Sale & Record Stock Out</button>
                    <button id="downloadInvoicePdfBtn" style="background-color: #dc3545; color: white;">Download PDF</button>
                    <button id="backToCartBtn">Back to Cart</button>
                </div>
            </div>
        </section>

        <div id="downloadableInvoice" class="hidden">
            <img src="img.png" alt="MASS Company Logo Watermark" class="invoice-watermark">
            
            <div class="download-invoice-header"> 
                <img src="img.png" alt="MASS Company Logo" class="invoice-logo">
                <h1>Modern Apparel Style Solution (MASS) <br>Invoice</h1>
            </div>
            
            <div class="invoice-details">
                <div>
                    <strong>Invoice Date:</strong> <span id="downloadInvoiceDate"></span><br>
                    <strong>Invoice No:</strong> <span id="downloadInvoiceNo"></span>
                </div>
                <div>
                    <strong>Customer Name:</strong> <span id="downloadCustomerName">N/A</span><br>
                    <strong>Contact:</strong> <span id="downloadCustomerContact">N/A</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Unit Price (TK)</th>
                        <th>Subtotal (TK)</th>
                    </tr>
                </thead>
                <tbody id="downloadInvoiceTableBody">
                </tbody>
            </table>
            <div class="invoice-total-summary"> 
                <div>Subtotal: <span id="downloadInvoiceSubTotal">0.00 TK</span></div>
                <div id="downloadDiscountRow">Discount: <span id="downloadInvoiceDiscount">0.00 TK</span></div>  
                <div>Total (Net): <span id="downloadInvoiceTotal">0.00 TK</span></div>
                <div>Previous Due: <span id="downloadInvoicePreviousDue" class="due-amount-highlight">0.00 TK</span></div>
                <div>Total Payable:  <span id="downloadInvoiceTotalPayable" class="payable-amount-highlight">0.00 TK</span></div>
                <div>Paid: <span id="downloadInvoicePaid">0.00 TK</span></div>
                <div>Due: <span id="downloadInvoiceDue" class="due-amount-highlight">0.00 TK</span></div>
                </div>
            <div class="invoice-footer">
                Thank you for your business!<br>
                Modern Apparel Style Solution (MASS), Gazipura-27 ,Tongi, Dhaka, Bangladesh<br>
                Phone number:  01710989035    , Gmail :  Mass.info247@gmail.com <br>
                Date Generated: <span id="generatedDateTime"></span>
            </div>
        </div>

        <section id="customersSection" class="hidden">
            <h2>Customer List</h2>
            <div id="customerEditFormContainer" class="customer-edit-form hidden">
                <h4>Edit Customer Details</h4>
                <label for="editCustomerPhone">Phone Number:</label>
                <input type="text" id="editCustomerPhone" readonly><br>
                
                <label for="editCustomerName">Customer Name:</label>
                <input type="text" id="editCustomerName"><br>
                
                <label for="editCustomerAddress">Address:</label>
                <input type="text" id="editCustomerAddress"><br>
                
                <div class="form-buttons">
                    <button type="button" id="saveCustomerEditBtn" class="save-customer-btn">Save Changes</button>
                    <button type="button" id="cancelCustomerEditBtn" class="cancel-edit-btn">Cancel</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="customerListTable">
                    <thead>
                        <tr>
                            <th>Phone Number</th>
                            <th>Customer Name</th>
                            <th>Total Purchases (TK)</th>
                            <th>Outstanding Due (TK)</th>
                            <th>Number of Orders</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customerListTableBody">
                    </tbody>
                </table>
               
            </div>
        </section>

        <section id="customerReportSection" class="hidden">
            <h2>Customer Purchase History: <span id="customerReportName"></span> (<span id="customerReportPhone"></span>)</h2>
            <button id="backToCustomersList">Back to Customer List</button>
            
            <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="allPurchases">All Purchase History</button>
                <button class="tab-btn" data-tab="duePayments">Due Payment Log</button>
            </div>
            
            <!-- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
            <div class="tab-content-container">
                <!-- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ 1: All Purchase History -->
                <div id="allPurchasesTab" class="tab-content active">
                    <h3>All Purchases</h3>
                    <div id="customerPurchaseHistory" class="table-container scrollable-content">
                        <!-- Purchase invoices will be dynamically added here -->
                    </div>
                    
                    <div class="purchase-summary">
                        <strong>Sum Total of All Purchases:</strong> <span id="customerTotalSpent">0.00 TK</span><br>
                        <strong>Total Outstanding Due:</strong> <span id="customerTotalDue" class="due-amount-highlight">0.00 TK</span>
                    </div>
                </div>
                
                <!-- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ 2: Due Payment Log -->
                <div id="duePaymentsTab" class="tab-content">
                    <h3>Payment Log (Due Payments Only):</h3>
                    <div class="table-container scrollable-content">
                        <table id="customerPaymentsLogTable" style="margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Payment Amount (TK)</th>
                                    <th>Ref. Invoice No</th>
                                    <th>Cleared From Oldest Due</th>
                                </tr>
                            </thead>
                            <tbody id="customerPaymentsLogBody">
                                <tr><td colspan="4" style="text-align: center;">No due payments recorded.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="reportByMonthSection" class="hidden">
            <h2>Sales Report (Date Range)</h2>
            <div id="monthlyReportControls">
                <div class="date-range-picker-container">
                    <label for="dateRangeInput">
                        <i class="fa-solid fa-calendar" style="margin-right: 5px; color: #28a745;"></i> Select Date
                    </label>
                    <input type="text" id="dateRangeInput" placeholder="Click to select dates">
                </div>
                
                <div class="date-range-display">
                    <span id="startDateDisplay">DD/MM/YYYY</span>
                    <span class="date-range-separator">to</span>
                    <span id="endDateDisplay">DD/MM/YYYY</span>
                </div>
                
                <button id="setDateRangeBtn">Generate Report</button>
            </div>
            
            <h3>Summary for Selected Date Range:</h3>
            <table id="monthlyReportTable">
                <thead>
                    <tr>
                        <th>Total Invoices</th>
                        <th>Total Gross Sales (Subtotal)</th>
                        <th>Total Discount Given</th>
                        <th>Total Net Sales (Grand Total)</th>
                        <th>Total Paid Amount</th>
                        <th>Total New Due Generated</th>
                    </tr>
                </thead>
                <tbody id="monthlyReportSummaryBody">
                </tbody>
            </table>

            <h3>Detailed Invoice List:</h3>
            <div class="table-container scrollable-content">
                <table id="monthlyReportDetailTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Invoice No</th>
                            <th>Customer Name</th>
                            <th>Net Sale (TK)</th>
                            <th>Discount (TK)</th>
                            <th>Due (TK)</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyReportDetailBody">
                    </tbody>
                </table>
                <div class="scroll-indicator">
                    <i class="fas fa-chevron-down"></i>
                    <span>Scroll down for more invoices</span>
                </div>
            </div>
        </section>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script type="module" defer>
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCA-7y10NVwFG5hCNaafSw6_w1D0IsXo7s",
            authDomain: "mass-244c7.firebaseapp.com",
            databaseURL: "https://mass-244c7-default-rtdb.firebaseio.com",
            projectId: "mass-244c7",
            storageBucket: "mass-244c7.firebasestorage.app",
            messagingSenderId: "73049426644",
            appId: "1:73049426644:web:db8b7c598f6192f4700941",
            measurementId: "G-0DR3XNB5VQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // References to Firebase paths
        const stockDataRef = ref(database, 'stockData');
        const stockInLogRef = ref(database, 'stockInLog');
        const stockOutLogRef = ref(database, 'stockOutLog');
        const customersRef = ref(database, 'customers');

        // --- Data Storage (updated to prioritize Firebase) ---
        let stockData = [];
        let stockInLog = [];
        let stockOutLog = [];
        let cartItems = []; // Cart is now just a temporary in-memory variable
        let customers = [];
        let currentCustomerPreviousDue = 0; // Global for previous due
        let editingCustomerPhone = null; // For customer edit functionality

        // --- NEW: Date Range Variables ---
        let selectedStartDate = null;
        let selectedEndDate = null;
        let flatpickrInstance = null;

        // --- Utility Functions for Data Handling ---

        // Function to save data to Firebase
        async function saveToFirebase(dataRef, data) {
            try {
                await set(dataRef, data);
                console.log(`Data saved to Firebase: ${dataRef.key}`);
            } catch (error) {
                console.error(`Error saving data to Firebase ${dataRef.key}:`, error);
                alert('Error saving data to cloud. Check your internet connection.');
            }
        }

        // ‚úÖ CRITICAL FIX APPLIED: Function to calculate a single customer's total outstanding due
        function getCustomerTotalDue(customer) {
            let totalDue = 0;
            if (customer && customer.purchases && customer.purchases.length > 0) {
                customer.purchases.forEach(purchase => {
                    totalDue += purchase.dueAmount || 0;
                });
            }
            return parseFloat(totalDue.toFixed(2));
        }

        // üéØ MODIFIED FUNCTION: generateInvoiceNumber (INV-DDMMYY-XXX)
        function generateInvoiceNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            
            const yearString = year.toString().slice(-2);
            const monthString = month.toString().padStart(2, '0');
            const dayString = day.toString().padStart(2, '0');
            
            let monthlyInvoiceCount = 0;
            
            customers.forEach(customer => {
                if (customer.purchases) {
                    customer.purchases.forEach(purchase => {
                        const [purchaseDay, purchaseMonth, purchaseYear] = purchase.date.split('/').map(Number);
                        
                        if (purchaseMonth === month && purchaseYear === year) {
                            monthlyInvoiceCount++;
                        }
                    });
                }
            });
            
            const nextInvoiceNumber = monthlyInvoiceCount + 1;
            
            return `INV-${dayString}${monthString}${yearString}-${nextInvoiceNumber.toString().padStart(3, '0')}`;
        }

        // Function to format currency
        function formatCurrency(amount) {
            return `${parseFloat(amount).toFixed(2)} TK`;
        }

        // Function to calculate total stock value
        function calculateTotalStockValue() {
            let totalValue = 0;
            stockData.forEach(item => {
                totalValue += item.quantity * item.price;
            });
            return totalValue;
        }

        // Function to calculate total customer due
        function calculateTotalCustomerDue() {
            let totalDue = 0;
            customers.forEach(customer => {
                if (customer.purchases) {
                    customer.purchases.forEach(purchase => {
                        totalDue += purchase.dueAmount || 0;
                    });
                }
            });
            return totalDue;
        }

        // Function to calculate total quantity in stock
        function calculateTotalQuantity() {
            let totalQty = 0;
            stockData.forEach(item => {
                totalQty += item.quantity;
            });
            return totalQty;
        }

        // --- NEW: Function to update Pie Chart with item quantities inside and total outside ---
        function updatePieChart() {
            const pieChart = document.getElementById('stockPieChart');
            const pieChartContainer = document.querySelector('.pie-chart-container');
            const pieCenterText = document.getElementById('pieChartTotal');
            const pieOuterText = document.getElementById('pieOuterTotal');
            const pieChartLabel = document.getElementById('pieChartLabel');
            
            if (!pieChart) return;
            
            // Clear existing pie chart and item labels
            pieChart.innerHTML = '';
            
            // Remove existing item labels
            const existingLabels = document.querySelectorAll('.item-label');
            existingLabels.forEach(label => label.remove());
            
            // Aggregate stock data by item name
            const itemAggregation = {};
            let totalQuantity = 0;
            
            stockData.forEach(item => {
                const itemName = item.itemName;
                if (!itemAggregation[itemName]) {
                    itemAggregation[itemName] = {
                        name: itemName,
                        quantity: 0,
                        colorIndex: 0
                    };
                }
                itemAggregation[itemName].quantity += item.quantity;
                totalQuantity += item.quantity;
            });
            
            // Convert to array and sort by quantity (descending)
            const items = Object.values(itemAggregation);
            items.sort((a, b) => b.quantity - a.quantity);
            
            // Assign colors to items
            const colorClasses = [
                'stroke-color-1', 'stroke-color-2', 'stroke-color-3', 
                'stroke-color-4', 'stroke-color-5', 'stroke-color-6',
                'stroke-color-7', 'stroke-color-8', 'stroke-color-9', 
                'stroke-color-10'
            ];
            
            items.forEach((item, index) => {
                item.colorIndex = Math.min(index, colorClasses.length - 1);
            });
            
            // Update center text with number of items
            if (pieCenterText) {
                pieCenterText.textContent = items.length;
            }
            
            // Update outer text with total stock quantity
            if (pieOuterText) {
                pieOuterText.textContent = totalQuantity;
                pieOuterText.title = `Total Stock: ${totalQuantity} units`;
            }
            
            // Update pie chart label
            if (pieChartLabel) {
                pieChartLabel.textContent = totalQuantity;
            }
            
            // If no items, show empty state
            if (items.length === 0) {
                pieChart.innerHTML = '<circle cx="16" cy="16" r="15" fill="#f0f0f0"/>';
                return;
            }
            
            // Calculate pie chart segments
            const radius = 15;
            const circumference = 2 * Math.PI * radius;
            let cumulativePercent = 0;
            
            items.forEach((item, index) => {
                const percent = item.quantity / totalQuantity;
                const dashArray = `${percent * circumference} ${circumference}`;
                const dashOffset = -cumulativePercent * circumference;
                
                // Create pie segment
                const segment = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                segment.setAttribute('cx', '16');
                segment.setAttribute('cy', '16');
                segment.setAttribute('r', radius);
                segment.setAttribute('fill', 'none');
                segment.setAttribute('stroke-width', '32');
                segment.setAttribute('stroke-linecap', 'round');
                segment.setAttribute('stroke-dasharray', dashArray);
                segment.setAttribute('stroke-dashoffset', dashOffset);
                segment.classList.add('pie-segment', colorClasses[item.colorIndex]);
                segment.setAttribute('data-item-name', item.name);
                segment.setAttribute('data-quantity', item.quantity);
                
                pieChart.appendChild(segment);
                
                // Calculate position for item label inside pie chart
                if (percent > 0.10) { // Only show label if segment is big enough
                    const middleAngle = (cumulativePercent + percent / 2) * 2 * Math.PI;
                    
                    // Calculate label position (inside the pie, closer to center)
                    const labelRadius = radius * 0.4; // Place labels closer to center
                    const labelX = 16 + labelRadius * Math.cos(middleAngle);
                    const labelY = 16 + labelRadius * Math.sin(middleAngle);
                    
                    // Create item label
                    const label = document.createElement('div');
                    label.classList.add('item-label');
                    
                    // Display item quantity
                    label.textContent = item.quantity;
                    label.style.left = `calc(50% + ${(labelX - 16) * 1.9}px)`; // Scale for container
                    label.style.top = `calc(50% + ${(labelY - 16) * 1.9}px)`;
                    label.style.transform = `translate(-50%, -50%)`;
                    label.style.color = 'white';
                    label.style.textShadow = '1px 1px 2px rgba(0,0,0,0.7)';
                    label.style.fontSize = '6px';
                    label.style.fontWeight = 'bold';
                    label.title = `${item.name}: ${item.quantity} units`;
                    
                    pieChartContainer.appendChild(label);
                }
                
                cumulativePercent += percent;
            });
        }

        // Function to update cart summary
        function updateCartSummary() {
            const totalStockValue = calculateTotalStockValue();
            const totalCustomerDue = calculateTotalCustomerDue();
            let cartTotal = 0;
            
            cartItems.forEach(item => {
                cartTotal += item.quantity * item.price;
            });
            
            if (document.getElementById('totalStockValue')) {
                document.getElementById('totalStockValue').textContent = formatCurrency(totalStockValue);
            }
            if (document.getElementById('totalCustomerDue')) {
                document.getElementById('totalCustomerDue').textContent = formatCurrency(totalCustomerDue);
            }
            if (document.getElementById('cartTotalValue')) {
                document.getElementById('cartTotalValue').textContent = formatCurrency(cartTotal);
            }
            
            // Update dashboard values
            updateDashboard();
        }

        // Function to update dashboard
        function updateDashboard() {
            const totalStockValue = calculateTotalStockValue();
            const totalCustomerDue = calculateTotalCustomerDue();
            const totalQty = calculateTotalQuantity();
            const cartItemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            
            if (document.getElementById('dashboardStockValue')) {
                document.getElementById('dashboardStockValue').textContent = formatCurrency(totalStockValue);
            }
            if (document.getElementById('dashboardCustomerDue')) {
                document.getElementById('dashboardCustomerDue').textContent = formatCurrency(totalCustomerDue);
            }
            if (document.getElementById('dashboardCartItems')) {
                document.getElementById('dashboardCartItems').textContent = cartItemCount;
            }
            
            // Update pie chart
            updatePieChart();
        }

        // Function to update cart count on invoice button
        function updateCartCount() {
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const invoiceBtn = document.querySelector('#btnSellInvoice span');
            
            if (totalItems > 0) {
                invoiceBtn.innerHTML = `Invoice <span class="cart-count-badge">${totalItems}</span>`;
            } else {
                invoiceBtn.innerHTML = 'Invoice';
            }
        }

        // Separate function for adding to cart with animation
        function addToCart(itemName, itemSize, quantity = 1) {
            const availableItem = stockData.find(item =>
                item.itemName.toLowerCase() === itemName.toLowerCase() &&
                item.itemSize.toLowerCase() === itemSize.toLowerCase()
            );

            if (!availableItem) {
                alert(`Item "${itemName}" with size "${itemSize}" not found in stock.`);
                return;
            }

            let totalAvailableQuantity = 0;
            stockData.filter(i =>
                i.itemName.toLowerCase() === itemName.toLowerCase() &&
                i.itemSize.toLowerCase() === itemSize.toLowerCase()
            ).forEach(i => totalAvailableQuantity += i.quantity);

            const currentCartQuantity = cartItems.find(item =>
                item.itemName.toLowerCase() === itemName.toLowerCase() &&
                item.itemSize.toLowerCase() === itemSize.toLowerCase()
            )?.quantity || 0;

            if ((currentCartQuantity + quantity) > totalAvailableQuantity) {
                alert(`Not enough stock of "${itemName}" (${itemSize}). Available in stock: ${totalAvailableQuantity}. You already have ${currentCartQuantity} in cart.`);
                return;
            }

            let itemInCart = cartItems.find(item =>
                item.itemName.toLowerCase() === itemName.toLowerCase() &&
                item.itemSize.toLowerCase() === itemSize.toLowerCase()
            );

            if (itemInCart) {
                itemInCart.quantity += quantity;
            } else {
                cartItems.push({
                    itemName: availableItem.itemName,
                    itemSize: availableItem.itemSize,
                    quantity: quantity,
                    price: parseFloat(availableItem.price)
                });
            }

            updateCartCount();
            
            // Animation effect without popup
            const icon = document.querySelector(`[data-item-name="${itemName}"][data-item-size="${itemSize}"]`);
            if (icon) {
                icon.classList.add('cart-add-animation');
                const originalHTML = icon.innerHTML;
                icon.innerHTML = '<i class="fas fa-check"></i>';
                
                setTimeout(() => {
                    icon.innerHTML = originalHTML;
                    icon.classList.remove('cart-add-animation');
                }, 500);
            }
            
            // Update dashboard
            updateDashboard();
        }

        // --- Firebase Data Listener (Primary Data Source) ---
        onValue(stockDataRef, (snapshot) => {
            if (snapshot.exists()) {
                stockData = snapshot.val();
                console.log("StockData from Firebase:", stockData);
                updateDashboard();
                updatePieChart();
                if (!document.getElementById('stockViewSection').classList.contains('hidden')) {
                    renderStockView();
                }
                updateCartSummary();
            } else {
                stockData = [];
                console.log("No stockData in Firebase.");
                updatePieChart(); // Update pie chart even when empty
            }
        });

        onValue(stockInLogRef, (snapshot) => {
            if (snapshot.exists()) {
                stockInLog = snapshot.val();
                console.log("StockInLog from Firebase:", stockInLog);
            } else {
                stockInLog = [];
                console.log("No stockInLog in Firebase.");
            }
        });

        onValue(stockOutLogRef, (snapshot) => {
            if (snapshot.exists()) {
                stockOutLog = snapshot.val();
                console.log("StockOutLog from Firebase:", stockOutLog);
            } else {
                stockOutLog = [];
                console.log("No stockOutLog in Firebase.");
            }
        });

        onValue(customersRef, (snapshot) => {
            if (snapshot.exists()) {
                customers = snapshot.val();
                console.log("Customers from Firebase:", customers);
                updateDashboard();
                updateCartSummary();
                
                if (!document.getElementById('customersSection').classList.contains('hidden')) {
                    renderCustomersList();
                }
                if (!document.getElementById('customerReportSection').classList.contains('hidden')) {
                    const customerPhone = document.getElementById('customerReportPhone').textContent;
                    if (customerPhone) {
                        renderCustomerReport(customerPhone);
                    }
                }
            } else {
                customers = [];
                console.log("No customers in Firebase.");
            }
        });
        
        // JavaScript Logic
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const contentDiv = document.getElementById('content');
            const dashboardSection = document.getElementById('dashboardSection');
            const stockViewSection = document.getElementById('stockViewSection');
            const stockEntrySection = document.getElementById('stockEntrySection');
            const overallDataViewSection = document.getElementById('overallDataViewSection');
            const itemReportSection = document.getElementById('itemReportSection');
            const cartViewSection = document.getElementById('cartViewSection');
            const sellInvoiceSection = document.getElementById('sellInvoiceSection');
            const customersSection = document.getElementById('customersSection');
            const customerReportSection = document.getElementById('customerReportSection');
            const reportByMonthSection = document.getElementById('reportByMonthSection');

            // Buttons
            const btnDashboard = document.getElementById('btnDashboard');
            const btnStockView = document.getElementById('btnStockView');
            const btnStockEntry = document.getElementById('btnStockEntry');
            const btnSellInvoice = document.getElementById('btnSellInvoice');
            const btnCustomers = document.getElementById('btnCustomers');
            const btnMonthlyReport = document.getElementById('btnMonthlyReport');
            const btnOverallDataView = document.getElementById('btnOverallDataView');
            const backToAllDataBtn = document.getElementById('backToAllData');
            const backToCustomersListBtn = document.getElementById('backToCustomersList');
            
            // Quick action buttons
            const quickStockView = document.getElementById('quickStockView');
            const quickStockEntry = document.getElementById('quickStockEntry');
            const quickSell = document.getElementById('quickSell');
            const quickCustomers = document.getElementById('quickCustomers');

            // Stock Entry Form Elements
            const stockEntryForm = document.getElementById('stockEntryForm');
            const addStockBtn = document.getElementById('addStockBtn');
            const removeStockBtn = document.getElementById('removeStockBtn');

            // Customer Edit Form Elements
            const customerEditFormContainer = document.getElementById('customerEditFormContainer');
            const editCustomerPhone = document.getElementById('editCustomerPhone');
            const editCustomerName = document.getElementById('editCustomerName');
            const editCustomerAddress = document.getElementById('editCustomerAddress');
            const saveCustomerEditBtn = document.getElementById('saveCustomerEditBtn');
            const cancelCustomerEditBtn = document.getElementById('cancelCustomerEditBtn');

            // Tables
            const currentStockTableBody = document.querySelector('#currentStockTable tbody');
            const allCurrentStockTableBody = document.querySelector('#allCurrentStockTable tbody');
            const allStockInLogTableBody = document.querySelector('#allStockInLogTable tbody');
            const allStockOutLogTableBody = document.querySelector('#allStockOutLogTable tbody');
            const itemInReportTableBody = document.querySelector('#itemInReportTable tbody');
            const itemOutReportTableBody = document.querySelector('#itemOutReportTable tbody');
            const itemCurrentReportTableBody = document.querySelector('#itemCurrentReportTable tbody');
            const customerListTableBody = document.getElementById('customerListTableBody');
            const cartTableBody = document.getElementById('cartTableBody');
            const customerPaymentsLogBody = document.getElementById('customerPaymentsLogBody');

            // Sell & Invoice Specific Elements
            const invoiceTableBody = document.getElementById('invoiceTableBody');
            const invoiceTotalDisplay = document.getElementById('invoiceTotal');
            const paidAmountInput = document.getElementById('paidAmount');
            const dueAmountDisplay = document.getElementById('dueAmountDisplay');
            const dueAmountRow = document.getElementById('dueAmountRow');
            const finalizeSaleBtn = document.getElementById('finalizeSaleBtn');
            const backToCartBtn = document.getElementById('backToCartBtn');
            const invoiceDateDisplay = document.getElementById('invoiceDateDisplay');
            const invoiceNoDisplay = document.getElementById('invoiceNoDisplay');
            const customerPhoneInput = document.getElementById('customerPhone');
            const customerNameInput = document.getElementById('customerName');
            const customerAddressInput = document.getElementById('customerAddress');
            const invoiceCustomerNameDisplay = document.getElementById('invoiceCustomerName');
            const invoiceCustomerPhoneDisplay = document.getElementById('invoiceCustomerPhone');
            const customerOutstandingDueOnInvoice = document.getElementById('customerOutstandingDueOnInvoice');
            const goToInvoiceBtn = document.getElementById('goToInvoiceBtn');
            const clearCartBtn = document.getElementById('clearCartBtn');
            const invoiceSubTotalDisplay = document.getElementById('invoiceSubTotal'); 
            
            // REFERENCES FOR INVOICE/DISCOUNT/DUE
            const discountAmountInput = document.getElementById('discountAmount');
            const applyDiscountCheckbox = document.getElementById('applyDiscountCheckbox');
            const discountInputRow = document.getElementById('discountInputRow');
            const invoiceTotalRow = document.getElementById('invoiceTotalRow'); 
            const previousDueDisplay = document.getElementById('previousDueDisplay'); 
            const totalPayableDisplay = document.getElementById('totalPayableDisplay'); 
            const downloadInvoicePdfBtn = document.getElementById('downloadInvoicePdfBtn'); 

            // Elements for hidden downloadable invoice
            const downloadableInvoiceDiv = document.getElementById('downloadableInvoice');
            const downloadInvoiceDate = document.getElementById('downloadInvoiceDate');
            const downloadInvoiceNo = document.getElementById('downloadInvoiceNo');
            const downloadCustomerName = document.getElementById('downloadCustomerName');
            const downloadCustomerContact = document.getElementById('downloadCustomerContact');
            const downloadInvoiceTableBody = document.getElementById('downloadInvoiceTableBody');
            const downloadInvoiceTotal = document.getElementById('downloadInvoiceTotal');
            const downloadInvoicePaid = document.getElementById('downloadInvoicePaid');
            const downloadInvoiceDue = document.getElementById('downloadInvoiceDue');
            const generatedDateTime = document.getElementById('generatedDateTime');

            // NEW ELEMENTS FOR DOWNLOADABLE INVOICE TEMPLATE
            const downloadInvoiceSubTotal = document.getElementById('downloadInvoiceSubTotal');
            const downloadInvoiceDiscount = document.getElementById('downloadInvoiceDiscount');
            const downloadDiscountRow = document.getElementById('downloadDiscountRow'); 
            const downloadInvoicePreviousDue = document.getElementById('downloadInvoicePreviousDue');
            const downloadInvoiceTotalPayable = document.getElementById('downloadInvoiceTotalPayable');

            // Customer Report Elements
            const customerReportNameSpan = document.getElementById('customerReportName');
            const customerReportPhoneSpan = document.getElementById('customerReportPhone');
            const customerPurchaseHistoryDiv = document.getElementById('customerPurchaseHistory');
            const customerTotalSpentSpan = document.getElementById('customerTotalSpent');
            const customerTotalDueSpan = document.getElementById('customerTotalDue');

            // NEW: Monthly Report Elements - SINGLE DATE RANGE PICKER
            const dateRangeInput = document.getElementById('dateRangeInput');
            const setDateRangeBtn = document.getElementById('setDateRangeBtn');
            const monthlyReportSummaryBody = document.getElementById('monthlyReportSummaryBody');
            const monthlyReportDetailBody = document.getElementById('monthlyReportDetailBody');
            const startDateDisplay = document.getElementById('startDateDisplay');
            const endDateDisplay = document.getElementById('endDateDisplay');

            // Helper function to hide all sections
            function hideAllSections() {
                document.querySelectorAll('main > section').forEach(section => {
                    section.classList.add('hidden');
                });
                downloadableInvoiceDiv.classList.add('hidden');
                
                // Remove active class from all buttons
                document.querySelectorAll('.modern-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }

            // Function to show a specific section and highlight the button
            function showSection(sectionId, buttonId = null) {
                hideAllSections();
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('hidden');
                    
                    // Highlight the active button
                    if (buttonId) {
                        const button = document.getElementById(buttonId);
                        if (button) {
                            button.classList.add('active');
                        }
                    }
                }
            }

            // Function to show dashboard
            function showDashboard() {
                showSection('dashboardSection', 'btnDashboard');
                updateDashboard();
            }

            // Function to render current stock view
            function renderStockView() {
                showSection('stockViewSection', 'btnStockView');
                currentStockTableBody.innerHTML = '';
                
                let totalItems = 0;
                let totalQuantity = 0;
                let totalValue = 0;
                
                // Aggregate stock data
                const aggregatedStock = {};
                stockData.forEach(item => {
                    const key = `${item.itemName}_${item.itemSize}`;
                    if (aggregatedStock[key]) {
                        aggregatedStock[key].quantity += item.quantity;
                    } else {
                        aggregatedStock[key] = { ...item, price: parseFloat(item.price) || 0 };
                    }
                    
                    // Calculate totals
                    totalItems++;
                    totalQuantity += item.quantity;
                    totalValue += item.quantity * item.price;
                });
                
                // Update summary
                document.getElementById('totalItemsCount').textContent = totalItems;
                document.getElementById('totalQuantity').textContent = totalQuantity;
                document.getElementById('totalStockValueMain').textContent = formatCurrency(totalValue);
                
                // Render table
                for (const key in aggregatedStock) {
                    const item = aggregatedStock[key];
                    const row = currentStockTableBody.insertRow();
                    row.insertCell(0).textContent = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(item.quantity * item.price);
                    
                    const addCell = row.insertCell(5);
                    const addIcon = document.createElement('button');
                    addIcon.classList.add('add-to-cart-icon');
                    addIcon.innerHTML = '<i class="fas fa-cart-plus"></i>';
                    addIcon.dataset.itemName = item.itemName;
                    addIcon.dataset.itemSize = item.itemSize;
                    addCell.appendChild(addIcon);
                }
                
                if (stockData.length === 0) {
                    currentStockTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No stock data available.</td></tr>';
                }
            }

            // Function to show stock entry section
            function showStockEntry() {
                showSection('stockEntrySection', 'btnStockEntry');
            }

            // Function to show cart view section
            function showCartView() {
                showSection('cartViewSection', 'btnSellInvoice');
                renderCartView();
            }

            // Function to show customers section
            function showCustomers() {
                showSection('customersSection', 'btnCustomers');
                renderCustomersList();
            }

            // Function to show monthly report section
            function showMonthlyReport() {
                showSection('reportByMonthSection', 'btnMonthlyReport');
                initializeDateRangePicker();
                monthlyReportSummaryBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Select date range to generate report.</td></tr>`;
                monthlyReportDetailBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No invoices found for this period.</td></tr>`;
            }

            // Function to show overall data view section
            function showOverallDataView() {
                showSection('overallDataViewSection', 'btnOverallDataView');
                renderOverallDataView();
            }

            // --- NEW: Initialize Date Range Picker (Flatpickr) ---
            function initializeDateRangePicker() {
                if (flatpickrInstance) {
                    flatpickrInstance.destroy();
                }
                
                flatpickrInstance = flatpickr("#dateRangeInput", {
                    mode: "range",
                    dateFormat: "d/m/Y",
                    altInput: true,
                    altFormat: "d/m/Y",
                    locale: {
                        firstDayOfWeek: 0,
                        weekdays: {
                            shorthand: ["‡¶∞‡¶¨‡¶ø", "‡¶∏‡ßã‡¶Æ", "‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤", "‡¶¨‡ßÅ‡¶ß", "‡¶¨‡ßÉ‡¶π", "‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞", "‡¶∂‡¶®‡¶ø"],
                            longhand: ["‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞", "‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞", "‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞", "‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞", "‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞", "‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞", "‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞"]
                        },
                        months: {
                            shorthand: ["‡¶ú‡¶æ‡¶®‡ßÅ", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã", "‡¶®‡¶≠‡ßá", "‡¶°‡¶ø‡¶∏‡ßá"],
                            longhand: ["‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"]
                        }
                    },
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length === 2) {
                            // Auto-sort: ‡¶õ‡ßã‡¶ü ‡¶°‡ßá‡¶ü‡¶ü‡¶æ Start, ‡¶¨‡ßú ‡¶°‡ßá‡¶ü‡¶ü‡¶æ End
                            const sortedDates = [...selectedDates].sort((a, b) => a - b);
                            selectedStartDate = sortedDates[0];
                            selectedEndDate = sortedDates[1];
                            
                            // Update display with preview highlight
                            updateDateDisplay(true);
                            
                            // Show preview highlight
                            startDateDisplay.classList.add('preview-highlight');
                            endDateDisplay.classList.add('preview-highlight');
                            
                            // Update button text
                            setDateRangeBtn.textContent = 'Set & Generate Report';
                        }
                    }
                });
                
                // Reset display
                updateDateDisplay(false);
            }

            // --- NEW: Update Date Display with/without preview ---
            function updateDateDisplay(isPreview = false) {
                const formatDate = (date) => {
                    if (!date) return 'DD/MM/YYYY';
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                if (isPreview && selectedStartDate && selectedEndDate) {
                    startDateDisplay.textContent = formatDate(selectedStartDate);
                    endDateDisplay.textContent = formatDate(selectedEndDate);
                } else {
                    // Default display
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDateDisplay.textContent = formatDate(firstDay);
                    endDateDisplay.textContent = formatDate(today);
                    
                    // Remove preview highlight
                    startDateDisplay.classList.remove('preview-highlight');
                    endDateDisplay.classList.remove('preview-highlight');
                    
                    // Reset button text
                    setDateRangeBtn.textContent = 'Generate Report';
                    
                    // Set default dates
                    selectedStartDate = firstDay;
                    selectedEndDate = today;
                }
            }

            // --- NEW: Parse DD/MM/YYYY date string to Date object ---
            function parseDate(dateStr) {
                if (!dateStr) return null;
                const [day, month, year] = dateStr.split('/').map(Number);
                return new Date(year, month - 1, day);
            }

            // --- NEW: Generate Monthly Report with Date Range ---
            function generateMonthlyReport() {
                if (!selectedStartDate || !selectedEndDate) {
                    alert("Please select a date range first.");
                    return;
                }

                // Adjust end date to include the entire day
                const adjustedEndDate = new Date(selectedEndDate);
                adjustedEndDate.setHours(23, 59, 59, 999);

                let totalInvoices = 0;
                let totalGrossSales = 0;
                let totalDiscount = 0;
                let totalNetSales = 0;
                let totalPaidAmount = 0;
                let totalNewDueGenerated = 0;
                const monthlyInvoices = [];

                customers.forEach(customer => {
                    customer.purchases.forEach(purchase => {
                        const purchaseDate = parseDate(purchase.date);
                        
                        if (purchaseDate && purchaseDate >= selectedStartDate && purchaseDate <= adjustedEndDate) {
                            totalInvoices++;
                            
                            const subTotal = purchase.subTotal || purchase.totalAmount || 0;
                            const discount = purchase.discount || 0;
                            const totalAmount = purchase.totalAmount || 0;
                            const paidAmount = purchase.paidAmount || 0;
                            const dueAmount = purchase.dueAmount || 0;
                            
                            totalGrossSales += subTotal;
                            totalDiscount += discount;
                            totalNetSales += totalAmount;
                            totalPaidAmount += paidAmount;
                            
                            let newDueGenerated = totalAmount - Math.max(0, paidAmount - (purchase.previousDue || 0));
                            if (newDueGenerated < 0) newDueGenerated = 0; 
                            
                            totalNewDueGenerated += newDueGenerated;

                            monthlyInvoices.push({
                                date: purchase.date,
                                invoiceNo: purchase.invoiceNo,
                                customerName: customer.name || customer.phone || 'Guest',
                                netSale: totalAmount,
                                discount: discount,
                                due: dueAmount 
                            });
                        }
                    });
                });

                // Render Summary
                monthlyReportSummaryBody.innerHTML = '';
                const summaryRow = monthlyReportSummaryBody.insertRow();
                summaryRow.insertCell(0).textContent = totalInvoices;
                summaryRow.insertCell(1).textContent = formatCurrency(totalGrossSales);
                summaryRow.insertCell(2).textContent = formatCurrency(totalDiscount);
                summaryRow.insertCell(3).textContent = formatCurrency(totalNetSales);
                summaryRow.insertCell(4).textContent = formatCurrency(totalPaidAmount);
                summaryRow.insertCell(5).textContent = formatCurrency(totalNewDueGenerated);

                // Render Details
                monthlyReportDetailBody.innerHTML = '';
                if (monthlyInvoices.length === 0) {
                    const startFormatted = `${selectedStartDate.getDate().toString().padStart(2, '0')}/${(selectedStartDate.getMonth() + 1).toString().padStart(2, '0')}/${selectedStartDate.getFullYear()}`;
                    const endFormatted = `${selectedEndDate.getDate().toString().padStart(2, '0')}/${(selectedEndDate.getMonth() + 1).toString().padStart(2, '0')}/${selectedEndDate.getFullYear()}`;
                    monthlyReportDetailBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No invoices found between ${startFormatted} and ${endFormatted}.</td></tr>`;
                } else {
                    monthlyInvoices.sort((a, b) => {
                        const dateA = parseDate(a.date);
                        const dateB = parseDate(b.date);
                        return dateA - dateB;
                    });
                    
                    monthlyInvoices.forEach(invoice => {
                        const detailRow = monthlyReportDetailBody.insertRow();
                        detailRow.insertCell(0).textContent = invoice.date;
                        detailRow.insertCell(1).textContent = invoice.invoiceNo;
                        detailRow.insertCell(2).textContent = invoice.customerName;
                        detailRow.insertCell(3).textContent = formatCurrency(invoice.netSale);
                        detailRow.insertCell(4).textContent = formatCurrency(invoice.discount);
                        
                        const dueCell = detailRow.insertCell(5);
                        dueCell.textContent = formatCurrency(invoice.due);
                        if (invoice.due > 0) {
                            dueCell.classList.add('due-amount-highlight');
                        }
                    });
                }
                
                // Remove preview highlight after setting
                startDateDisplay.classList.remove('preview-highlight');
                endDateDisplay.classList.remove('preview-highlight');
                
                // Update button text
                setDateRangeBtn.textContent = 'Generate Report';
            }

            // Render Overall Data View
            function renderOverallDataView() {
                hideAllSections();
                overallDataViewSection.classList.remove('hidden');

                // Render Current Aggregated Stock
                allCurrentStockTableBody.innerHTML = '';
                const aggregatedStock = {};
                stockData.forEach(item => {
                    const key = `${item.itemName}_${item.itemSize}`;
                    if (aggregatedStock[key]) {
                        aggregatedStock[key].quantity += item.quantity;
                    } else {
                        aggregatedStock[key] = { ...item };
                    }
                });

                for (const key in aggregatedStock) {
                    const item = aggregatedStock[key];
                    const row = allCurrentStockTableBody.insertRow();
                    const itemNameCell = row.insertCell(0);
                    itemNameCell.textContent = item.itemName;
                    itemNameCell.classList.add('item-name-link');
                    itemNameCell.dataset.itemName = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(item.quantity * item.price);
                }

                // Render Stock In Log
                allStockInLogTableBody.innerHTML = '';
                stockInLog.forEach(item => {
                    const row = allStockInLogTableBody.insertRow();
                    const itemNameCell = row.insertCell(1);
                    row.insertCell(0).textContent = item.date;
                    itemNameCell.textContent = item.itemName;
                    itemNameCell.classList.add('item-name-link');
                    itemNameCell.dataset.itemName = item.itemName;
                    row.insertCell(2).textContent = item.itemSize;
                    row.insertCell(3).textContent = item.quantity;
                    row.insertCell(4).textContent = formatCurrency(item.price);
                });

                // Render Stock Out Log
                allStockOutLogTableBody.innerHTML = '';
                stockOutLog.forEach(item => {
                    const row = allStockOutLogTableBody.insertRow();
                    const itemNameCell = row.insertCell(1);
                    row.insertCell(0).textContent = item.date;
                    itemNameCell.textContent = item.itemName;
                    itemNameCell.classList.add('item-name-link');
                    itemNameCell.dataset.itemName = item.itemName;
                    row.insertCell(2).textContent = item.itemSize;
                    row.insertCell(3).textContent = item.quantity;
                    row.insertCell(4).textContent = item.invoiceNo || 'N/A';
                });
            }

            // Function to render individual item report
            function renderItemReport(itemName) {
                hideAllSections();
                itemReportSection.classList.remove('hidden');

                document.getElementById('itemReportName').textContent = itemName;
                document.getElementById('itemReportInName').textContent = itemName;
                document.getElementById('itemReportOutName').textContent = itemName;
                document.getElementById('itemReportCurrentName').textContent = itemName;

                // Populate Stock In for this item
                itemInReportTableBody.innerHTML = '';
                stockInLog.filter(item => item.itemName.toLowerCase() === itemName.toLowerCase())
                        .forEach(item => {
                            const row = itemInReportTableBody.insertRow();
                            row.insertCell(0).textContent = item.date;
                            row.insertCell(1).textContent = item.itemSize;
                            row.insertCell(2).textContent = item.quantity;
                            row.insertCell(3).textContent = formatCurrency(item.price);
                        });

                // Populate Stock Out for this item
                itemOutReportTableBody.innerHTML = '';
                stockOutLog.filter(item => item.itemName.toLowerCase() === itemName.toLowerCase())
                        .forEach(item => {
                            const row = itemOutReportTableBody.insertRow();
                            row.insertCell(0).textContent = item.date;
                            row.insertCell(1).textContent = item.itemSize;
                            row.insertCell(2).textContent = item.quantity;
                            row.insertCell(3).textContent = item.invoiceNo || 'N/A';
                        });

                // Populate Current Stock for this item (aggregated by size)
                itemCurrentReportTableBody.innerHTML = '';
                const itemAggregatedStock = {};
                stockData.filter(item => item.itemName.toLowerCase() === itemName.toLowerCase())
                        .forEach(item => {
                            const key = item.itemSize;
                            if (itemAggregatedStock[key]) {
                                itemAggregatedStock[key].quantity += item.quantity;
                            } else {
                                itemAggregatedStock[key] = { ...item };
                            }
                        });
                for (const key in itemAggregatedStock) {
                    const item = itemAggregatedStock[key];
                    const row = itemCurrentReportTableBody.insertRow();
                    row.insertCell(0).textContent = item.itemSize;
                    row.insertCell(1).textContent = item.quantity;
                    row.insertCell(2).textContent = formatCurrency(item.price);
                }
            }

            // --- Cart and Invoice Logic ---
            function renderCartView() {
                hideAllSections();
                cartViewSection.classList.remove('hidden');
                cartTableBody.innerHTML = '';
            
                if (cartItems.length === 0) {
                    cartTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Your cart is empty.</td></tr>`;
                    updateCartSummary();
                    return;
                }
            
                cartItems.forEach((item, index) => {
                    const row = cartTableBody.insertRow();
                    const subtotal = item.quantity * item.price;
                    row.insertCell(0).textContent = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
            
                    const quantityCell = row.insertCell(2);
                    
                    // Create a container for quantity control
                    const quantityContainer = document.createElement('div');
                    quantityContainer.className = 'quantity-control';
                    
                    // Minus button
                    const minusBtn = document.createElement('button');
                    minusBtn.className = 'quantity-btn minus';
                    minusBtn.innerHTML = '<i class="fas fa-minus"></i>';
                    minusBtn.dataset.index = index;
                    minusBtn.dataset.action = 'decrease';
                    
                    // Quantity input - FIXED: Changed to text input for free typing
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'text'; // Changed from 'number' to 'text'
                    quantityInput.value = item.quantity;
                    quantityInput.className = 'cart-quantity-input';
                    quantityInput.dataset.index = index;
                    quantityInput.placeholder = 'Qty';
                    
                    // Plus button
                    const plusBtn = document.createElement('button');
                    plusBtn.className = 'quantity-btn plus';
                    plusBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    plusBtn.dataset.index = index;
                    plusBtn.dataset.action = 'increase';
                    
                    // Function to update quantity
                    function updateQuantity(index, newQuantity) {
                        // Validate
                        if (isNaN(newQuantity) || newQuantity < 1) {
                            alert('Please enter a valid quantity (minimum 1)');
                            return cartItems[index].quantity;
                        }
                        
                        // Check stock availability
                        const item = cartItems[index];
                        const totalAvailableQuantity = stockData.filter(s => 
                            s.itemName.toLowerCase() === item.itemName.toLowerCase() && 
                            s.itemSize.toLowerCase() === item.itemSize.toLowerCase()
                        ).reduce((acc, s) => acc + s.quantity, 0);
                        
                        if (newQuantity > totalAvailableQuantity) {
                            alert(`Not enough stock of "${item.itemName}" (${item.itemSize}). Available: ${totalAvailableQuantity}.`);
                            return cartItems[index].quantity;
                        }
                        
                        // Update cart
                        cartItems[index].quantity = newQuantity;
                        renderCartView();
                        return newQuantity;
                    }
                    
                    // Button click events
                    minusBtn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const newQty = cartItems[index].quantity - 1;
                        if (newQty >= 1) {
                            updateQuantity(index, newQty);
                        }
                    });
                    
                    plusBtn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const newQty = cartItems[index].quantity + 1;
                        updateQuantity(index, newQty);
                    });
                    
                    // Input blur event (when user finishes typing)
                    quantityInput.addEventListener('blur', function() {
                        const index = parseInt(this.dataset.index);
                        const newValue = this.value.trim();
                        
                        if (newValue === '') {
                            this.value = cartItems[index].quantity;
                            return;
                        }
                        
                        const newQuantity = parseInt(newValue);
                        const updatedValue = updateQuantity(index, newQuantity);
                        this.value = updatedValue;
                    });
                    
                    // Enter key support
                    quantityInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            this.blur();
                        }
                    });
                    
                    // Add elements to container
                    quantityContainer.appendChild(minusBtn);
                    quantityContainer.appendChild(quantityInput);
                    quantityContainer.appendChild(plusBtn);
                    quantityCell.appendChild(quantityContainer);
            
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(subtotal);
                    
                    const actionCell = row.insertCell(5);
                    actionCell.innerHTML = `
                        <div class="cart-action-buttons">
                            <button class="remove-from-cart" data-index="${index}">Remove</button>
                        </div>
                    `;
                });
                
                updateCartSummary();
            }

            // Remove from cart
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-from-cart')) {
                    const index = parseInt(e.target.dataset.index);
                    cartItems.splice(index, 1);
                    renderCartView();
                }
            });

            clearCartBtn.addEventListener('click', () => {
                const confirmClear = confirm('Are you sure you want to clear your cart?');
                if (confirmClear) {
                    cartItems = [];
                    renderCartView();
                }
            });

            function renderInvoiceFromCart() {
                hideAllSections();
                sellInvoiceSection.classList.remove('hidden');

                if (cartItems.length === 0) {
                    alert('Your cart is empty. Please add items to the cart before generating an invoice.');
                    renderCartView();
                    return;
                }

                invoiceTableBody.innerHTML = '';
                let totalSubtotal = 0;

                cartItems.forEach((item) => {
                    const row = invoiceTableBody.insertRow();
                    const subtotal = item.quantity * item.price;
                    totalSubtotal += subtotal;

                    row.insertCell(0).textContent = item.itemName;
                    row.insertCell(1).textContent = item.itemSize;
                    row.insertCell(2).textContent = item.quantity;
                    row.insertCell(3).textContent = formatCurrency(item.price);
                    row.insertCell(4).textContent = formatCurrency(subtotal);
                });
                
                // Set invoice date and generate number
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                invoiceDateDisplay.textContent = `${day}/${month}/${year}`;
                
                invoiceNoDisplay.textContent = generateInvoiceNumber();

                const phone = customerPhoneInput.value.trim();
                const existingCustomer = customers.find(c => c.phone === phone);
                let totalDueForCustomer = 0;

                if (existingCustomer) {
                    customerNameInput.value = existingCustomer.name || '';
                    customerAddressInput.value = existingCustomer.address || '';
                    invoiceCustomerNameDisplay.textContent = existingCustomer.name || 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = existingCustomer.phone || 'N/A';
                    
                    totalDueForCustomer = getCustomerTotalDue(existingCustomer); 
                } else {
                    invoiceCustomerNameDisplay.textContent = 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = 'N/A';
                }

                currentCustomerPreviousDue = totalDueForCustomer;
                customerOutstandingDueOnInvoice.textContent = formatCurrency(currentCustomerPreviousDue);
                previousDueDisplay.textContent = formatCurrency(currentCustomerPreviousDue);
                
                applyDiscountCheckbox.checked = false;
                discountAmountInput.value = '0';

                paidAmountInput.value = totalSubtotal.toFixed(2);
                
                calculateDueAmount(); 
            }

            // UPDATED: Function to calculate all totals
            function calculateDueAmount() {
                const subTotalAmount = cartItems.reduce((acc, item) => acc + (item.quantity * item.price), 0);
                invoiceSubTotalDisplay.textContent = formatCurrency(subTotalAmount);
                
                let discountAmount = 0;
                if (applyDiscountCheckbox.checked) {
                    discountAmount = parseFloat(discountAmountInput.value) || 0;
                    if (discountAmount < 0) discountAmount = 0;
                    if (discountAmount > subTotalAmount) discountAmount = subTotalAmount;
                    discountAmountInput.value = discountAmount.toFixed(2);
                    
                    discountInputRow.classList.remove('hidden');
                    invoiceTotalRow.classList.remove('hidden'); 
                } else {
                    discountInputRow.classList.add('hidden');
                    invoiceTotalRow.classList.add('hidden'); 
                }
                
                const totalAmountAfterDiscount = Math.max(0, subTotalAmount - discountAmount);
                invoiceTotalDisplay.textContent = formatCurrency(totalAmountAfterDiscount);

                const totalPayable = totalAmountAfterDiscount + currentCustomerPreviousDue;
                totalPayableDisplay.textContent = formatCurrency(totalPayable); 

                const paidAmount = parseFloat(paidAmountInput.value) || 0;
                let dueAmount = totalPayable - paidAmount;

                if (dueAmount < 0) {
                    dueAmount = 0;
                }

                dueAmountDisplay.textContent = formatCurrency(dueAmount);

                if (dueAmount <= 0) {
                    dueAmountRow.classList.add('hidden');
                } else {
                    dueAmountRow.classList.remove('hidden');
                }
            }

            // Stock Entry and Remove functionality - ADDED FIX
            addStockBtn.addEventListener('click', async () => {
                const itemName = document.getElementById('entryItemName').value.trim();
                const itemSize = document.getElementById('entryItemSize').value.trim();
                const quantity = parseInt(document.getElementById('entryQuantity').value);
                const price = parseFloat(document.getElementById('entryPrice').value);

                if (!itemName || !itemSize || !quantity || !price || quantity <= 0 || price <= 0) {
                    alert('Please fill all fields with valid values.');
                    return;
                }

                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const date = `${day}/${month}/${year}`;

                // Add to stock data
                const newStockData = [...stockData];
                const existingItemIndex = newStockData.findIndex(item => 
                    item.itemName.toLowerCase() === itemName.toLowerCase() && 
                    item.itemSize.toLowerCase() === itemSize.toLowerCase()
                );

                if (existingItemIndex !== -1) {
                    // Update existing item
                    newStockData[existingItemIndex].quantity += quantity;
                    newStockData[existingItemIndex].price = price; // Update price
                } else {
                    // Add new item
                    newStockData.push({
                        itemName: itemName,
                        itemSize: itemSize,
                        quantity: quantity,
                        price: price
                    });
                }

                // Add to stock in log
                const newStockInLog = [...stockInLog];
                newStockInLog.push({
                    date: date,
                    itemName: itemName,
                    itemSize: itemSize,
                    quantity: quantity,
                    price: price
                });

                // Save to Firebase
                await saveToFirebase(stockDataRef, newStockData);
                await saveToFirebase(stockInLogRef, newStockInLog);

                alert('Stock added successfully!');
                
                // Clear form
                stockEntryForm.reset();
            });

            removeStockBtn.addEventListener('click', async () => {
                const itemName = document.getElementById('entryItemName').value.trim();
                const itemSize = document.getElementById('entryItemSize').value.trim();
                const quantity = parseInt(document.getElementById('entryQuantity').value);

                if (!itemName || !itemSize || !quantity || quantity <= 0) {
                    alert('Please fill all fields with valid values.');
                    return;
                }

                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const date = `${day}/${month}/${year}`;

                // Check if item exists in stock
                const newStockData = [...stockData];
                const existingItemIndex = newStockData.findIndex(item => 
                    item.itemName.toLowerCase() === itemName.toLowerCase() && 
                    item.itemSize.toLowerCase() === itemSize.toLowerCase()
                );

                if (existingItemIndex === -1) {
                    alert(`Item "${itemName}" with size "${itemSize}" not found in stock.`);
                    return;
                }

                if (newStockData[existingItemIndex].quantity < quantity) {
                    alert(`Not enough stock. Available: ${newStockData[existingItemIndex].quantity}, Requested: ${quantity}`);
                    return;
                }

                // Remove from stock
                newStockData[existingItemIndex].quantity -= quantity;
                if (newStockData[existingItemIndex].quantity <= 0) {
                    newStockData.splice(existingItemIndex, 1);
                }

                // Add to stock out log (for manual removal)
                const newStockOutLog = [...stockOutLog];
                newStockOutLog.push({
                    date: date,
                    itemName: itemName,
                    itemSize: itemSize,
                    quantity: quantity,
                    invoiceNo: 'MANUAL_REMOVAL'
                });

                // Save to Firebase
                await saveToFirebase(stockDataRef, newStockData);
                await saveToFirebase(stockOutLogRef, newStockOutLog);

                alert('Stock removed successfully!');
                
                // Clear form
                stockEntryForm.reset();
            });

            // Finalize Sale Button Event Listener
            finalizeSaleBtn.addEventListener('click', async () => {
                if (cartItems.length === 0) {
                    alert('No items in the invoice to finalize. Add items to cart first.');
                    return;
                }

                const confirmSale = confirm('Are you sure you want to finalize this sale and record stock out? This action cannot be undone.');
                if (!confirmSale) {
                    return;
                }

                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const date = `${day}/${month}/${year}`;
                const dateTime = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
                
                const currentInvoiceNo = invoiceNoDisplay.textContent;
                const customerPhone = customerPhoneInput.value.trim();
                const customerName = customerNameInput.value.trim() || 'Guest';
                const customerAddress = customerAddressInput.value.trim() || 'N/A';
                
                calculateDueAmount();
                const subTotalAmount = parseFloat(invoiceSubTotalDisplay.textContent.replace(' TK', ''));
                const totalInvoiceAmount = parseFloat(invoiceTotalDisplay.textContent.replace(' TK', ''));
                const discountAmount = applyDiscountCheckbox.checked ? parseFloat(discountAmountInput.value) || 0 : 0;
                const totalPayable = parseFloat(totalPayableDisplay.textContent.replace(' TK', '')); 
                let paidAmount = parseFloat(paidAmountInput.value);
                
                let finalOutstandingDue = totalPayable - paidAmount; 

                if (finalOutstandingDue < 0) {
                    finalOutstandingDue = 0;
                }

                if (isNaN(paidAmount) || paidAmount < 0) {
                    alert('Please enter a valid paid amount (non-negative number).');
                    return;
                }
                if (paidAmount > totalPayable) {
                    alert('Paid amount cannot be greater than the Total Payable amount.');
                    return;
                }

                const newStockData = [...stockData];
                const newStockOutLog = [...stockOutLog];
                const newCustomers = JSON.parse(JSON.stringify(customers));

                // 1. Stock Check
                for (const soldItem of cartItems) {
                    let totalAvailableQuantity = 0;
                    stockData.filter(i =>
                        i.itemName.toLowerCase() === soldItem.itemName.toLowerCase() &&
                        i.itemSize.toLowerCase() === soldItem.itemSize.toLowerCase()
                    ).forEach(i => totalAvailableQuantity += i.quantity);

                    if (totalAvailableQuantity < soldItem.quantity) {
                        alert(`Cannot finalize sale: Not enough stock of "${soldItem.itemName}" (${soldItem.itemSize}). Available: ${totalAvailableQuantity}, Requested: ${soldItem.quantity}. Please adjust cart.`);
                        return;
                    }
                }

                // 2. Stock Out Logging and Update
                cartItems.forEach(soldItem => {
                    const stockItemIndex = newStockData.findIndex(s =>
                        s.itemName.toLowerCase() === soldItem.itemName.toLowerCase() &&
                        s.itemSize.toLowerCase() === soldItem.itemSize.toLowerCase()
                    );

                    if (stockItemIndex !== -1) {
                        newStockData[stockItemIndex].quantity -= soldItem.quantity;
                        if (newStockData[stockItemIndex].quantity <= 0) {
                            newStockData.splice(stockItemIndex, 1);
                        }
                    }

                    newStockOutLog.push({
                        date: date,
                        itemName: soldItem.itemName,
                        itemSize: soldItem.itemSize,
                        quantity: soldItem.quantity,
                        invoiceNo: currentInvoiceNo
                    });
                });

                // 3. Customer & Due Update
                let currentInvoiceDue = totalInvoiceAmount;
                let oldPaidAmount = 0;

                if (customerPhone) {
                    let existingCustomerIndex = newCustomers.findIndex(c => c.phone === customerPhone);
                    let customer;

                    if (existingCustomerIndex !== -1) {
                        customer = newCustomers[existingCustomerIndex];
                        customer.name = customerName;
                        customer.address = customerAddress;
                    } else {
                        customer = {
                            phone: customerPhone,
                            name: customerName,
                            address: customerAddress,
                            purchases: [],
                            paymentsLog: []
                        };
                        newCustomers.push(customer);
                    }
                    
                    let remainingPayment = paidAmount;
                    let oldDueCleared = 0;
                    let clearedInvoiceNo = '';

                    customer.purchases.forEach(purchase => {
                        if (remainingPayment > 0 && purchase.dueAmount > 0) {
                            const amountToClear = Math.min(remainingPayment, purchase.dueAmount);
                            purchase.dueAmount = parseFloat((purchase.dueAmount - amountToClear).toFixed(2));
                            remainingPayment = parseFloat((remainingPayment - amountToClear).toFixed(2));
                            oldDueCleared += amountToClear;
                            clearedInvoiceNo += (clearedInvoiceNo ? ', ' : '') + purchase.invoiceNo;
                        }
                    });
                    oldPaidAmount = oldDueCleared;

                    if (remainingPayment > 0) {
                        const amountToClear = Math.min(remainingPayment, currentInvoiceDue);
                        currentInvoiceDue = parseFloat((currentInvoiceDue - amountToClear).toFixed(2));
                        remainingPayment = parseFloat((remainingPayment - amountToClear).toFixed(2));
                    }
                    
                    const purchaseDetails = {
                        invoiceNo: currentInvoiceNo,
                        date: date,
                        items: cartItems.map(item => ({
                            itemName: item.itemName,
                            itemSize: item.itemSize,
                            quantity: item.quantity,
                            unitPrice: item.price,
                            subtotal: item.quantity * item.price 
                        })),
                        totalAmount: totalInvoiceAmount,
                        subTotal: subTotalAmount,
                        discount: discountAmount,
                        previousDue: currentCustomerPreviousDue,
                        totalPayable: totalPayable,
                        paidAmount: paidAmount,
                        dueAmount: Math.max(0, currentInvoiceDue) 
                    };
                    
                    customer.purchases.push(purchaseDetails);

                    if (paidAmount > 0) {
                        if (!customer.paymentsLog) {
                            customer.paymentsLog = [];
                        }
                        
                        let currentPaidForInvoices = paidAmount - oldDueCleared;
                        let refInvoices = clearedInvoiceNo;
                        
                        if (currentPaidForInvoices > 0) {
                            refInvoices += (refInvoices ? ', ' : '') + currentInvoiceNo;
                        }

                        customer.paymentsLog.push({
                            dateTime: dateTime,
                            paymentAmount: paidAmount,
                            clearedAmount: oldDueCleared + currentPaidForInvoices,
                            refInvoice: refInvoices.substring(0, 100)
                        });
                    }

                    await saveToFirebase(customersRef, newCustomers);
                }

                // 4. Final Save
                await saveToFirebase(stockDataRef, newStockData);
                await saveToFirebase(stockOutLogRef, newStockOutLog);

                alert('Sale finalized, stock and due amounts updated!');
                
                // 5. Cleanup
                cartItems = [];
                invoiceNoDisplay.textContent = '';
                customerPhoneInput.value = '';
                customerNameInput.value = '';
                customerAddressInput.value = '';
                paidAmountInput.value = '0';
                dueAmountDisplay.textContent = formatCurrency(0);
                invoiceSubTotalDisplay.textContent = formatCurrency(0);
                invoiceTotalDisplay.textContent = formatCurrency(0);
                previousDueDisplay.textContent = formatCurrency(0);
                totalPayableDisplay.textContent = formatCurrency(0);
                customerOutstandingDueOnInvoice.textContent = formatCurrency(0);
                currentCustomerPreviousDue = 0;
                applyDiscountCheckbox.checked = false;
                discountAmountInput.value = '0';

                dueAmountRow.classList.add('hidden');
                discountInputRow.classList.add('hidden'); 
                invoiceTotalRow.classList.add('hidden'); 

                showDashboard();
            });

            // --- Customer Section Logic ---
            function renderCustomersList() {
                hideAllSections();
                customersSection.classList.remove('hidden');
                customerListTableBody.innerHTML = '';
                customerEditFormContainer.classList.add('hidden');
                editingCustomerPhone = null;

                if (customers.length === 0) {
                    const row = customerListTableBody.insertRow();
                    row.insertCell(0).colSpan = 6;
                    row.cells[0].textContent = 'No customers found.';
                    row.cells[0].style.textAlign = 'center';
                    return;
                }

                customers.forEach(customer => {
                    const row = customerListTableBody.insertRow();
                    const phoneCell = row.insertCell(0);
                    phoneCell.textContent = customer.phone;
                    phoneCell.classList.add('customer-name-link');
                    phoneCell.dataset.customerPhone = customer.phone;

                    row.insertCell(1).textContent = customer.name || 'N/A';

                    let totalPurchasesAmount = 0;
                    
                    customer.purchases.forEach(purchase => {
                        totalPurchasesAmount += purchase.totalAmount || 0;
                    });
                    
                    const totalOutstandingDue = getCustomerTotalDue(customer); 
                    
                    row.insertCell(2).textContent = formatCurrency(totalPurchasesAmount);

                    const outstandingDueCell = row.insertCell(3);
                    outstandingDueCell.textContent = formatCurrency(totalOutstandingDue);
                    if (totalOutstandingDue > 0) {
                        outstandingDueCell.classList.add('due-amount-highlight');
                    }

                    row.insertCell(4).textContent = customer.purchases.length;
                    
                    const actionCell = row.insertCell(5);
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit-customer-btn');
                    editButton.dataset.customerPhone = customer.phone;
                    actionCell.appendChild(editButton);
                });
            }

            // Function to show customer edit form
            function showCustomerEditForm(customerPhone) {
                const customer = customers.find(c => c.phone === customerPhone);
                if (!customer) {
                    alert('Customer not found!');
                    return;
                }
                
                editingCustomerPhone = customerPhone;
                editCustomerPhone.value = customer.phone;
                editCustomerName.value = customer.name || '';
                editCustomerAddress.value = customer.address || '';
                customerEditFormContainer.classList.remove('hidden');
                
                customerEditFormContainer.scrollIntoView({ behavior: 'smooth' });
            }

            // Function to save customer edit
            async function saveCustomerEdit() {
                if (!editingCustomerPhone) return;
                
                const newName = editCustomerName.value.trim();
                const newAddress = editCustomerAddress.value.trim();
                
                if (!newName) {
                    alert('Customer name is required!');
                    return;
                }
                
                const newCustomers = JSON.parse(JSON.stringify(customers));
                const customerIndex = newCustomers.findIndex(c => c.phone === editingCustomerPhone);
                
                if (customerIndex !== -1) {
                    newCustomers[customerIndex].name = newName;
                    newCustomers[customerIndex].address = newAddress;
                    
                    await saveToFirebase(customersRef, newCustomers);
                    alert('Customer details updated successfully!');
                    
                    customerEditFormContainer.classList.add('hidden');
                    editingCustomerPhone = null;
                    
                    renderCustomersList();
                }
            }

            // Function to cancel customer edit
            function cancelCustomerEdit() {
                customerEditFormContainer.classList.add('hidden');
                editingCustomerPhone = null;
            }

            function renderCustomerReport(customerPhone) {
                hideAllSections();
                customerReportSection.classList.remove('hidden');

                const customer = customers.find(c => c.phone === customerPhone);
                if (!customer) {
                    alert('Customer not found!');
                    renderCustomersList();
                    return;
                }

                customerReportNameSpan.textContent = customer.name || 'N/A';
                customerReportPhoneSpan.textContent = customer.phone;
                
                // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                document.querySelector('.tab-btn[data-tab="allPurchases"]').classList.add('active');
                document.getElementById('allPurchasesTab').classList.add('active');

                // All Purchases ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                renderAllPurchasesTab(customer);
                
                // Due Payment Log ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                renderDuePaymentsTab(customer);
            }

            // All Purchases ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
            function renderAllPurchasesTab(customer) {
                const customerPurchaseHistoryDiv = document.getElementById('customerPurchaseHistory');
                customerPurchaseHistoryDiv.innerHTML = '';

                let grandTotalSpent = 0;

                if (customer.purchases.length === 0) {
                    customerPurchaseHistoryDiv.innerHTML = '<p>No purchase history for this customer.</p>';
                } else {
                    // Sort purchases by date (newest first)
                    const sortedPurchases = customer.purchases.sort((a,b) => {
                        const [dA, mA, yA] = a.date.split('/').map(Number);
                        const [dB, mB, yB] = b.date.split('/').map(Number);
                        const dateA = new Date(yA, mA - 1, dA);
                        const dateB = new Date(yB, mB - 1, dB);
                        return dateB - dateA;
                    });
                    
                    // Display first 3 invoices in full view
                    const invoicesToShowFull = Math.min(3, sortedPurchases.length);
                    
                    for (let i = 0; i < sortedPurchases.length; i++) {
                        const purchase = sortedPurchases[i];
                        const purchaseDiv = document.createElement('div');
                        purchaseDiv.className = 'purchase-invoice-card';
                        
                        grandTotalSpent += purchase.totalAmount;
                        
                        const currentTotalDue = getCustomerTotalDue(customer);

                        let dueActionHtml = '';
                        if (currentTotalDue > 0 && i === 0) {
                             dueActionHtml = `
                                <br>
                                <strong>Record Payment Against ALL Dues:</strong>
                                <input type="number" min="0" step="0.01" value="${currentTotalDue.toFixed(2)}" class="due-payment-input" id="dueInput_${customer.phone}">
                                <button class="pay-due-btn" data-customer-phone="${customer.phone}">Record Payment</button>
                                <p style="font-size: 10px; color: #888; margin-top: 5px;">*Recording payment here will clear the oldest outstanding invoices first.</p>
                            `;
                        }

                        purchaseDiv.innerHTML = `
                            <h4>Invoice No: ${purchase.invoiceNo} (Date: ${purchase.date})</h4>
                            <div style="margin-bottom: 10px;">
                                <strong>Subtotal (Gross):</strong> ${formatCurrency(purchase.subTotal || purchase.totalAmount)}<br>
                                <strong>Discount:</strong> ${formatCurrency(purchase.discount || 0)}<br>
                                <strong>Total (Net):</strong> ${formatCurrency(purchase.totalAmount)}<br>
                                <strong>Previous Due (at sale time):</strong> ${formatCurrency(purchase.previousDue || 0)}<br>
                                <strong>Total Payable (at sale time):</strong> ${formatCurrency(purchase.totalPayable || purchase.totalAmount + (purchase.previousDue || 0))}<br>
                                <strong>Paid Amount (at sale time):</strong> ${formatCurrency(purchase.paidAmount || 0)}<br>
                                <strong>Due Amount (from this invoice):</strong> <span class="${purchase.dueAmount > 0 ? 'due-amount-highlight' : ''}">${formatCurrency(purchase.dueAmount || 0)}</span>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Size</th>
                                        <th>Quantity</th>
                                        <th>Unit Price (TK)</th>
                                        <th>Subtotal (TK)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${purchase.items.map(item => `
                                        <tr>
                                            <td>${item.itemName}</td>
                                            <td>${item.itemSize}</td>
                                            <td>${item.quantity}</td>
                                            <td>${formatCurrency(item.unitPrice)}</td>
                                            <td>${formatCurrency(item.subtotal)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <button class="download-customer-invoice-btn" data-invoice-no="${purchase.invoiceNo}" data-customer-phone="${customer.phone}" style="margin-top: 10px;">Download Invoice (JPEG)</button>
                            ${i === 0 ? dueActionHtml : ''}
                        `;
                        
                        customerPurchaseHistoryDiv.appendChild(purchaseDiv);
                        
                        // Add separator after first 3 invoices
                        if (i === invoicesToShowFull - 1 && sortedPurchases.length > invoicesToShowFull) {
                            const separator = document.createElement('div');
                            separator.innerHTML = `<div class="scroll-indicator"><i class="fas fa-chevron-down"></i><span>Scroll down to view ${sortedPurchases.length - invoicesToShowFull} more invoices</span></div>`;
                            customerPurchaseHistoryDiv.appendChild(separator);
                        }
                    }
                }
                
                let grandTotalDue = getCustomerTotalDue(customer); 
                
                customerTotalSpentSpan.textContent = formatCurrency(grandTotalSpent);
                customerTotalDueSpan.textContent = formatCurrency(grandTotalDue);
            }

            // Due Payment Log ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
            function renderDuePaymentsTab(customer) {
                const paymentsLogBody = document.getElementById('customerPaymentsLogBody');
                paymentsLogBody.innerHTML = '';

                if (customer.paymentsLog && customer.paymentsLog.length > 0) {
                    customer.paymentsLog.sort((a, b) => {
                        const dateA = new Date(a.dateTime.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00'));
                        const dateB = new Date(b.dateTime.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00'));
                        return dateB - dateA;
                    }).forEach(log => {
                        const row = paymentsLogBody.insertRow();
                        row.insertCell(0).textContent = log.dateTime;
                        row.insertCell(1).textContent = formatCurrency(log.paymentAmount);
                        row.insertCell(2).textContent = log.refInvoice || 'N/A';
                        row.insertCell(3).textContent = formatCurrency(log.clearedAmount);
                    });
                } else {
                    paymentsLogBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No due payments recorded.</td></tr>';
                }
            }

            // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    const tabBtn = e.target;
                    const tabId = tabBtn.dataset.tab;
                    
                    // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    tabBtn.classList.add('active');
                    
                    // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const activeTab = document.getElementById(`${tabId}Tab`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                }
            });

            // --- Record Due Payment Logic ---
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('pay-due-btn')) {
                    const btn = e.target;
                    const customerPhone = btn.dataset.customerPhone;
                    const dueInput = document.getElementById(`dueInput_${customerPhone}`);
                    let paymentAmount = parseFloat(dueInput.value);

                    if (isNaN(paymentAmount) || paymentAmount <= 0) {
                        alert('Please enter a valid positive amount to pay.');
                        return;
                    }

                    const now = new Date();
                    const dateTime = now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
                    
                    const newCustomers = JSON.parse(JSON.stringify(customers)); 
                    const customer = newCustomers.find(c => c.phone === customerPhone);
                    if (!customer) {
                        alert('Error: Customer not found.');
                        return;
                    }
                    
                    const currentTotalDue = getCustomerTotalDue(customer);
                    if (paymentAmount > currentTotalDue) {
                        alert(`Payment amount (${formatCurrency(paymentAmount)}) cannot exceed the outstanding total due (${formatCurrency(currentTotalDue)}).`);
                        return;
                    }
                    
                    let remainingPayment = paymentAmount;
                    let oldDueCleared = 0;
                    let clearedInvoiceNo = '';

                    if (!customer.paymentsLog) {
                        customer.paymentsLog = [];
                    }

                    customer.purchases.forEach(purchase => {
                        if (remainingPayment > 0 && purchase.dueAmount > 0) {
                            const amountToClear = Math.min(remainingPayment, purchase.dueAmount);
                            purchase.dueAmount = parseFloat((purchase.dueAmount - amountToClear).toFixed(2));
                            remainingPayment = parseFloat((remainingPayment - amountToClear).toFixed(2));
                            oldDueCleared += amountToClear;
                            clearedInvoiceNo += (clearedInvoiceNo ? ', ' : '') + purchase.invoiceNo;
                        }
                    });
                    
                    customer.paymentsLog.push({
                        dateTime: dateTime,
                        paymentAmount: paymentAmount,
                        clearedAmount: oldDueCleared,
                        refInvoice: clearedInvoiceNo.substring(0, 100),
                    });

                    await saveToFirebase(customersRef, newCustomers);
                    
                    const newTotalDue = getCustomerTotalDue(newCustomers.find(c => c.phone === customerPhone));

                    alert(`Payment of ${formatCurrency(paymentAmount)} recorded successfully. New Total Outstanding Due: ${formatCurrency(newTotalDue)}`);
                    renderCustomerReport(customerPhone);
                }
            });

            // ‚úÖ UPDATED LOGIC: Download Invoice from Customer Report Section
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('download-customer-invoice-btn')) {
                    const btn = e.target;
                    const invoiceNo = btn.dataset.invoiceNo;
                    const customerPhone = btn.dataset.customerPhone;

                    const customer = customers.find(c => c.phone === customerPhone);
                    if (!customer) {
                        alert('Customer not found for this invoice.');
                        return;
                    }

                    const purchase = customer.purchases.find(p => p.invoiceNo === invoiceNo);
                    if (!purchase) {
                        alert('Invoice not found for this customer.');
                        return;
                    }

                    const purchaseTotalPayable = purchase.totalPayable || (purchase.totalAmount + (purchase.previousDue || 0));
                    const purchasePaidAmount = purchase.paidAmount || 0;
                    const finalOutstandingDueAfterTransaction = Math.max(0, purchaseTotalPayable - purchasePaidAmount);

                    downloadInvoiceDate.textContent = purchase.date;
                    downloadInvoiceNo.textContent = purchase.invoiceNo;
                    downloadCustomerName.textContent = customer.name || 'N/A';
                    downloadCustomerContact.textContent = customer.phone || 'N/A';
                    
                    const now = new Date();
                    const day = String(now.getDate()).padStart(2, '0');
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const year = now.getFullYear();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    generatedDateTime.textContent = `${day}/${month}/${year} ${hours}:${minutes}`;

                    downloadInvoiceTableBody.innerHTML = '';

                    purchase.items.forEach(item => {
                        const row = downloadInvoiceTableBody.insertRow();
                        row.insertCell(0).textContent = item.itemName;
                        row.insertCell(1).textContent = item.itemSize;
                        row.insertCell(2).textContent = item.quantity;
                        row.insertCell(3).textContent = formatCurrency(item.unitPrice);
                        row.insertCell(4).textContent = formatCurrency(item.subtotal);
                    });
                    
                    downloadInvoiceSubTotal.textContent = formatCurrency(purchase.subTotal || purchase.totalAmount || 0);
                    downloadInvoiceDiscount.textContent = formatCurrency(purchase.discount || 0);
                    downloadInvoicePreviousDue.textContent = formatCurrency(purchase.previousDue || 0);
                    downloadInvoiceTotalPayable.textContent = formatCurrency(purchase.totalPayable || purchase.totalAmount + (purchase.previousDue || 0));
                    
                    downloadInvoiceTotal.textContent = formatCurrency(purchase.totalAmount);
                    downloadInvoicePaid.textContent = formatCurrency(purchase.paidAmount);
                    
                    downloadInvoiceDue.textContent = formatCurrency(finalOutstandingDueAfterTransaction); 

                    const discountAmount = purchase.discount || 0;
                    const downloadDiscountDiv = downloadableInvoiceDiv.querySelector('#downloadDiscountRow'); 
                    const downloadTotalDiv = downloadableInvoiceDiv.querySelector('#downloadInvoiceTotal').closest('div'); 
                    
                    if (discountAmount <= 0) {
                        downloadDiscountDiv.classList.add('hidden');
                        downloadTotalDiv.classList.add('hidden'); 
                    } else {
                        downloadDiscountDiv.classList.remove('hidden');
                        downloadTotalDiv.classList.remove('hidden'); 
                    }

                    const downloadPaidDiv = downloadableInvoiceDiv.querySelector('#downloadInvoicePaid').closest('div');
                    if (purchase.paidAmount <= 0) {
                         downloadPaidDiv.classList.add('hidden');
                    } else {
                         downloadPaidDiv.classList.remove('hidden');
                    }

                    const downloadDueDiv = downloadableInvoiceDiv.querySelector('#downloadInvoiceDue').closest('div');
                    if (finalOutstandingDueAfterTransaction <= 0) {
                        downloadDueDiv.classList.add('hidden');
                    } else {
                        downloadDueDiv.classList.remove('hidden');
                    }

                    downloadableInvoiceDiv.style.position = 'absolute';
                    downloadableInvoiceDiv.style.left = '-9999px';
                    downloadableInvoiceDiv.style.top = '-9999px';
                    downloadableInvoiceDiv.classList.remove('hidden');

                    try {
                        if (typeof html2canvas === 'undefined') {
                            console.error("html2canvas library not loaded. Waiting for defer.");
                            alert("Error: Image generation library not loaded. Cannot download invoice. Try reloading the page.");
                            return;
                        }

                        const canvas = await html2canvas(downloadableInvoiceDiv, {
                            scale: 2,
                            useCORS: true,
                            logging: true,
                            onclone: (document) => {
                                document.querySelector('#downloadableInvoice .invoice-logo').style.display = 'block';
                                
                                const clonedDiscountAmount = parseFloat(document.getElementById('downloadInvoiceDiscount').textContent.replace(' TK', '')) || 0;
                                
                                const clonedDiscountRow = document.getElementById('downloadDiscountRow');
                                const clonedTotalNetRow = document.getElementById('downloadInvoiceTotal').closest('div');

                                if (clonedDiscountAmount <= 0) {
                                    clonedDiscountRow.classList.add('hidden'); 
                                    clonedTotalNetRow.classList.add('hidden'); 
                                } else {
                                    clonedDiscountRow.classList.remove('hidden');
                                    clonedTotalNetRow.classList.remove('hidden'); 
                                }
                                
                                const clonedPaidAmount = parseFloat(document.getElementById('downloadInvoicePaid').textContent.replace(' TK', '')) || 0;
                                if (clonedPaidAmount <= 0) {
                                    document.querySelector('#downloadableInvoice #downloadInvoicePaid').closest('div').classList.add('hidden');
                                } else {
                                    document.querySelector('#downloadableInvoice #downloadInvoicePaid').closest('div').classList.remove('hidden');
                                }
                                
                                const clonedFinalDue = parseFloat(document.getElementById('downloadInvoiceDue').textContent.replace(' TK', '')) || 0;
                                if (clonedFinalDue <= 0) {
                                    document.querySelector('#downloadableInvoice #downloadInvoiceDue').closest('div').classList.add('hidden');
                                } else {
                                    document.querySelector('#downloadableInvoice #downloadInvoiceDue').closest('div').classList.remove('hidden');
                                }
                            }
                        });

                        const imageDataURL = canvas.toDataURL('image/jpeg', 0.9);

                        const link = document.createElement('a');
                        link.href = imageDataURL;
                        link.download = `Invoice_${purchase.invoiceNo}_${customer.name || 'Customer'}.jpeg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        alert('Invoice downloaded successfully!');

                    } catch (error) {
                        console.error('Error generating invoice image:', error);
                        alert('Failed to generate invoice image. Please check the console for details and ensure the "img.png" logo is in the same folder as the HTML file.');
                    } finally {
                        downloadableInvoiceDiv.classList.add('hidden');
                        downloadableInvoiceDiv.style.position = '';
                        downloadableInvoiceDiv.style.left = '';
                        downloadableInvoiceDiv.style.top = '';
                    }
                }
            });

            // --- Dynamic Calculation & Conditional Discount Display ---
            applyDiscountCheckbox.addEventListener('change', calculateDueAmount); 
            discountAmountInput.addEventListener('input', calculateDueAmount);
            paidAmountInput.addEventListener('input', calculateDueAmount);
            
            downloadInvoicePdfBtn.addEventListener('click', () => {
                alert('The PDF generation feature is still under construction! Please use the JPEG download button on the Customer Report for now, which uses the same data.');
            });

            // --- Event Listeners for Navigation Buttons ---
            btnDashboard.addEventListener('click', showDashboard);
            btnStockView.addEventListener('click', renderStockView);
            btnStockEntry.addEventListener('click', showStockEntry);
            btnSellInvoice.addEventListener('click', showCartView);
            btnCustomers.addEventListener('click', showCustomers);
            btnMonthlyReport.addEventListener('click', showMonthlyReport);
            btnOverallDataView.addEventListener('click', showOverallDataView);
            
            // Quick action buttons
            quickStockView.addEventListener('click', renderStockView);
            quickStockEntry.addEventListener('click', showStockEntry);
            quickSell.addEventListener('click', showCartView);
            quickCustomers.addEventListener('click', showCustomers);
            
            // Other button event listeners
            goToInvoiceBtn.addEventListener('click', () => {
                hideAllSections();
                sellInvoiceSection.classList.remove('hidden');
                renderInvoiceFromCart();
            }); 
            
            backToCartBtn.addEventListener('click', showCartView);
            setDateRangeBtn.addEventListener('click', generateMonthlyReport); 
            backToAllDataBtn.addEventListener('click', showOverallDataView);
            backToCustomersListBtn.addEventListener('click', showCustomers);
            
            // Customer edit form buttons
            saveCustomerEditBtn.addEventListener('click', saveCustomerEdit);
            cancelCustomerEditBtn.addEventListener('click', cancelCustomerEdit);

            // ‚úÖ FIXED: Add to Cart icon click event for Stock View
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-icon') || 
                    e.target.closest('.add-to-cart-icon')) {
                    
                    const icon = e.target.classList.contains('add-to-cart-icon') ? 
                        e.target : e.target.closest('.add-to-cart-icon');
                    
                    const itemName = icon.dataset.itemName;
                    const itemSize = icon.dataset.itemSize;
                    
                    if (itemName && itemSize) {
                        addToCart(itemName, itemSize, 1);
                        alert(`"${itemName}" (Size: ${itemSize}) added to cart!`);
                    }
                }
            });

            // Event listener for clicking on item names in "Overall Data View"
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('item-name-link')) {
                    const itemName = e.target.dataset.itemName;
                    if (itemName) {
                        renderItemReport(itemName);
                    }
                } else if (e.target.classList.contains('customer-name-link')) {
                    const customerPhone = e.target.dataset.customerPhone;
                    if (customerPhone) {
                        renderCustomerReport(customerPhone);
                    }
                } else if (e.target.classList.contains('edit-customer-btn')) {
                    const customerPhone = e.target.dataset.customerPhone;
                    if (customerPhone) {
                        showCustomerEditForm(customerPhone);
                    }
                }
            });

            customerPhoneInput.addEventListener('input', () => {
                const phone = customerPhoneInput.value.trim();
                const existingCustomer = customers.find(c => c.phone === phone);
                let totalDue = 0;

                if (existingCustomer) {
                    customerNameInput.value = existingCustomer.name || '';
                    customerAddressInput.value = existingCustomer.address || '';
                    invoiceCustomerNameDisplay.textContent = existingCustomer.name || 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = existingCustomer.phone || 'N/A';

                    totalDue = getCustomerTotalDue(existingCustomer); 
                } else {
                    if (!customerNameInput.dataset.userEdited) {
                        customerNameInput.value = '';
                    }
                    if (!customerAddressInput.dataset.userEdited) {
                        customerAddressInput.value = '';
                    }
                    invoiceCustomerNameDisplay.textContent = phone ? phone : 'N/A';
                    invoiceCustomerPhoneDisplay.textContent = phone ? phone : 'N/A';
                }
                customerOutstandingDueOnInvoice.textContent = formatCurrency(totalDue);
                currentCustomerPreviousDue = totalDue;
                calculateDueAmount();
            });

            customerNameInput.addEventListener('input', () => {
                customerNameInput.dataset.userEdited = 'true';
                invoiceCustomerNameDisplay.textContent = customerNameInput.value.trim() || 'N/A';
            });
            customerAddressInput.addEventListener('input', () => {
                customerAddressInput.dataset.userEdited = 'true';
            });
            
            // Show dashboard on initial load
            showDashboard();
        });
    </script>
</body>
</html>
